import{a as N,p as B,n as w,F as j}from"./bootstrap-DI8pXSaz.js";import{n as F,c as O}from"./ns-prompt-popup-CidREd5w.js";import{_ as o}from"./lang-BINodpp-.js";import{_ as L}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{n as M}from"./currency-BCJk0SN4.js";import{r as m,c as d,o as c,b as r,a as p,t as u,f as b,w as h,i as y,F as g,e as T,n as U,g as C}from"./runtime-core.esm-bundler-DUdZl5j1.js";import"./chart-BXKSDqJb.js";import"./runtime-dom.esm-bundler-BJBE8XOq.js";const V={name:"ns-transaction-selector",props:["popup"],data(){return{configurations:[],warningMessage:!1,type:null}},mounted(){this.configurations=this.popup.params.configurations,this.warningMessage=this.popup.params.warningMessage,this.type=this.popup.params.type},methods:{__:o,nsCurrency:M,popupResolver:B,popupCloser:N,selectType(e){this.popupResolver(e)}}},R={class:"w-[85.71vw] md:w-[57.14vw] lg:w-[42.86vw] flex flex-col shadow-lg ns-box"},W={class:"ns-box-header p-2 border-b flex justify-between items-center"},E={key:0,class:"p-2"},H=["innerHTML"],q={class:"grid grid-cols-2"},D=["onClick"],J=["src","alt"],Y={class:"font-bold"};function z(e,t,n,_,i,s){const v=m("ns-notice");return c(),d("div",R,[r("div",W,[r("h3",null,u(s.__("Expense Type")),1)]),i.warningMessage?(c(),d("div",E,[b(v,{color:"info"},{title:h(()=>[y(u(s.__("Warning")),1)]),default:h(()=>[r("p",{innerHTML:i.warningMessage},null,8,H)]),_:1})])):p("",!0),r("div",q,[(c(!0),d(g,null,T(i.configurations,a=>(c(),d("div",{class:U([i.type===a.identifier?"info":"","h-40 elevation-surface hoverable flex-col flex items-center justify-center cursor-pointer"]),onClick:k=>s.selectType(a),key:a.identifier},[r("img",{src:a.icon,class:"w-20 my-2",alt:a.label},null,8,J),r("h3",Y,u(a.label),1)],10,D))),128))])])}const G=L(V,[["render",z]]),I={props:[],data(){return{configurations:[],activeTab:"create-customers",selectedConfiguration:{},isLoading:!1,tabs:[],unavailableType:!1,transaction:{},originalRecurrence:[],validation:new j,recurrence:[],warningMessage:!1}},computed:{},mounted(){window.nsTransactionData!==void 0&&(this.transaction=window.nsTransactionData),this.init()},watch:{},methods:{__:o,nsCurrency:M,confirmBeforeSave(){Popup.show(F,{title:o("Confirm Your Action"),message:o("The transaction is about to be saved. Would you like to confirm your action ?"),onAction:e=>{e&&this.saveTransaction()}})},saveTransaction(){const e=this.transaction.id!==void 0?"put":"post",t=this.transaction.id!==void 0?`/api/crud/ns.transactions/${this.transaction.id}`:"/api/crud/ns.transactions",n=this.configurations.filter(a=>a.identifier===this.selectedConfiguration.identifier);if(n.length!==1)return w.error(o("No configuration were choosen. Unable to proceed."));if(!this.validation.validateFields(n[0].fields))return w.error(o("Unable to proceed the form is not valid."));this.validation.disableFields(n[0].fields);const _=this.validation.extractFields(n[0].fields),i=this.validation.extractFields(this.recurrence),s={..._,...i},v={general:{}};for(let a in s)a==="name"?v[a]=s[a]:v.general[a]=s[a];nsHttpClient[e](t,v).subscribe({next:a=>{w.success(a.message),setTimeout(()=>{document.location=a.data.editUrl},1e3)},error:a=>{this.validation.enableFields(n[0].fields),w.error(a.message||o("An unexpected error occured."))}})},updateSelectLabel(){this.recurrence.length>0&&(this.recurrence[0].options=this.recurrence[0].options.map((e,t)=>{const n=this.originalRecurrence[0].options[t];return["x_after_month_starts","x_before_month_ends"].includes(e.value)?(e.label=n.label.replace("{day}",this.recurrence[1].value>=0&&this.recurrence[1].value<=1?`${this.recurrence[1].value} day`:`${this.recurrence[1].value} days`),e.label=n.label.replace("{day}",this.recurrence[1].value>=0&&this.recurrence[1].value<=1?`${this.recurrence[1].value} day`:`${this.recurrence[1].value} days`)):["on_specific_day"].includes(e.value)?e.label=n.label.replace("{day}",this.ordinalSuffix(this.recurrence[1].value)):["every_x_minutes"].includes(e.value)?e.label=n.label.replace("{minutes}",this.recurrence[1].value>=0&&this.recurrence[1].value<=1?o("{minutes} minute").replace("{minutes}",this.recurrence[1].value):o("{minutes} minutes").replace("{minutes}",this.recurrence[1].value)):["every_x_hours"].includes(e.value)?e.label=n.label.replace("{hours}",this.recurrence[1].value>=0&&this.recurrence[1].value<=1?o("{hours} hour").replace("{hours}",this.recurrence[1].value):o("{hours} hours").replace("{hours}",this.recurrence[1].value)):["every_x_days"].includes(e.value)&&(e.label=n.label.replace("{days}",this.recurrence[1].value>=0&&this.recurrence[1].value<=1?o("{days} day").replace("{days}",this.recurrence[1].value):o("{days} days").replace("{days}",this.recurrence[1].value))),e}))},setActiveTab(e){this.activeTab=e,this.updateSelectLabel()},executeCondition(e,t){if(e.shows){const n=t.filter(i=>Object.keys(e.shows).includes(i.name));return n.filter(i=>e.shows[i.name].includes(i.value)).length===n.length}return!0},setTabs(){const e=[{label:this.selectedConfiguration.label||o("N/A"),identifier:"general",active:!0,fields:this.selectedConfiguration.fields}];["ns.recurring-transaction","ns.entity-transaction"].includes(this.selectedConfiguration.identifier)&&e.push({label:o("Conditions"),identifier:"recurrence"}),this.tabs=e},async init(){try{this.isLoading=!0;const{configurations:e,recurrence:t,warningMessage:n}=await this.loadConfiguration();if(this.configurations=e,this.recurrence=t,this.warningMessage=n,this.originalRecurrence=JSON.parse(JSON.stringify(t)),this.transaction.type===void 0)await this.selectTransactionType();else{const _=this.configurations.filter(i=>i.identifier===this.transaction.type);if(_.length==0)return this.unavailableType=!0,this.isLoading=!1,Popup.show(O,{title:o("Unable to load the transaction"),message:o("You cannot edit this transaction if NexoPOS cannot perform background requests.")});this.processSelectedConfiguration(_[0])}this.isLoading=!1,this.setTabs()}catch(e){console.log(e)}},processSelectedConfiguration(e){e.fields=this.validation.createFields(e.fields),e.fields.forEach(t=>{t.name==="recurring"&&(["ns.recurring-transaction","ns.entity-transaction"].includes(e.identifier)?t.value=!0:t.value=!1),t.name==="type"&&(t.value=e.identifier)}),this.selectedConfiguration=e},handleSavedField(e,t){try{t.options.push({label:e.data.entry[t.props.optionAttributes.label],value:e.data.entry[t.props.optionAttributes.value]}),t.value=e.data.entry[t.props.optionAttributes.value]}catch{}},async selectTransactionType(){try{const e=await new Promise((t,n)=>{Popup.show(G,{resolve:t,reject:n,configurations:this.configurations,type:this.transaction.type,warningMessage:this.warningMessage})});this.processSelectedConfiguration(e)}catch(e){console.log(e)}},confirmTypeChange(){Popup.show(F,{title:o("Change Type"),message:o("By proceeding the current for and all your entries will be cleared. Would you like to proceed?"),onAction:e=>{e&&(delete this.transaction.type,this.init())}})},ordinalSuffix(e){var t=e%10,n=e%100;return t==1&&n!=11?e+"st":t==2&&n!=12?e+"nd":t==3&&n!=13?e+"rd":e+"th"},loadConfiguration(){return new Promise((e,t)=>{nsHttpClient.get(`/api/transactions/configurations/${this.transaction.id?this.transaction.id:""}`).subscribe({next:n=>{e(n)},error:n=>{t(n)}})})}}},K={key:0,class:"h-half w-full flex items-center justify-center"},Q={class:"flex flex-col"},X={class:"py-4"},Z={key:1,class:"flex items-center justify-center"},$={key:2},ee={class:"md:flex hidden flex-col md:flex-row -mx-2"},te={class:"px-2"},ne={class:"ns-button info"},se={class:"px-2"},ie={class:"ns-button success"},re={class:"my-3 md:hidden"},ae={class:"flex -mx-2"},oe={class:"px-2"},ce={class:"ns-button info"},le={class:"px-2"},ue={class:"ns-button success"};function de(e,t,n,_,i,s){const v=m("ns-spinner"),a=m("ns-button"),k=m("ns-notice"),S=m("ns-field"),A=m("ns-tabs-item"),P=m("ns-tabs");return c(),d(g,null,[i.isLoading&&!i.unavailableType?(c(),d("div",K,[r("div",Q,[b(v),r("div",X,[r("a",{onClick:t[0]||(t[0]=l=>s.init()),class:"text-info-tertiary hover:underline",href:"javascript:void(0)"},u(s.__("Change Type")),1)])])])):p("",!0),i.unavailableType&&!i.isLoading?(c(),d("div",Z,[b(k,{color:"warning"},{title:h(()=>[y(u(s.__("Unable to edit this transaction")),1)]),description:h(()=>[y(u(s.__("This transaction was created with a type that is no longer available. This type is no longer available because NexoPOS is unable to perform background requests.")),1)]),controls:h(()=>[b(a,{target:"_blank",href:"https://my.nexopos.com/en/documentation/troubleshooting/workers-or-async-requests-disabled?utm_source=nexopos&utm_campaign=warning&utm_medium=app",type:"warning"},{default:h(()=>[y(u(s.__("Learn More")),1)]),_:1})]),_:1})])):p("",!0),i.tabs.length>0&&!i.isLoading?(c(),d("div",$,[b(P,{active:i.activeTab,onActive:t[6]||(t[6]=l=>s.setActiveTab(l))},{extra:h(()=>[r("div",ee,[r("div",te,[r("div",ne,[r("button",{onClick:t[1]||(t[1]=l=>s.confirmTypeChange()),class:"py-1 px-2 text-sm rounded"},u(s.__("Change Type")),1)])]),r("div",se,[r("div",ie,[r("button",{onClick:t[2]||(t[2]=l=>s.confirmBeforeSave()),class:"py-1 px-2 text-sm rounded"},u(s.__("Save Transaction")),1)])])])]),default:h(()=>[(c(!0),d(g,null,T(i.tabs,l=>(c(),C(A,{key:l.identifier,identifier:l.identifier,label:l.label},{default:h(()=>[l.fields?(c(),d(g,{key:0},[i.selectedConfiguration.identifier==="ns.entity-transaction"?(c(),C(k,{key:0,class:"mb-2",color:"info"},{title:h(()=>[y(u(s.__("Warning")),1)]),description:h(()=>[y(u(s.__("While selecting entity transaction, the amount defined will be multiplied by the total user assigned to the User group selected.")),1)]),_:1})):p("",!0),(c(!0),d(g,null,T(l.fields,f=>(c(),C(S,{onSaved:x=>s.handleSavedField(x,f),key:f.name,field:f},null,8,["onSaved","field"]))),128))],64)):p("",!0),l.identifier==="recurrence"?(c(!0),d(g,{key:1},T(i.recurrence,f=>(c(),d(g,{key:f.name},[s.executeCondition(f,i.recurrence)?(c(),C(S,{key:0,onSaved:x=>s.handleSavedField(x,f),onChange:t[3]||(t[3]=x=>s.updateSelectLabel()),field:f},null,8,["onSaved","field"])):p("",!0)],64))),128)):p("",!0)]),_:2},1032,["identifier","label"]))),128)),r("div",re,[r("div",ae,[r("div",oe,[r("div",ce,[r("button",{onClick:t[4]||(t[4]=l=>s.confirmTypeChange()),class:"py-1 px-2 text-sm rounded"},u(s.__("Change Type")),1)])]),r("div",le,[r("div",ue,[r("button",{onClick:t[5]||(t[5]=l=>s.confirmBeforeSave()),class:"py-1 px-2 text-sm rounded"},u(s.__("Save Expense")),1)])])])])]),_:1},8,["active"])])):p("",!0)],64)}const be=L(I,[["render",de]]);export{be as default};
