import{Q as y}from"./browser-B-RaiDhA.js";import{k as b,h as u,E as h,D as k,z as C,c as w,o as v,b as s,t as l,a as P}from"./runtime-core.esm-bundler-DUdZl5j1.js";import{_ as q}from"./_plugin-vue_export-helper-DlAUqK2U.js";const R=b({name:"NsPosPermissionsPopup",props:["permission","popup","access_id","reject","resolve"],emits:["close","granted"],setup(e,{emit:t}){const a=u(!1),d=u(!1),o=u(),m=u(""),c=u({}),n=async()=>new Promise(async(r,f)=>{try{if(m.value=JSON.stringify({permission:e.permission,access_id:e.access_id}),o.value){const i=await y.toCanvas(o.value,m.value,{width:240,margin:1,color:{dark:"#1f2937",light:"#ffffff"}});d.value=!0,console.log({result:i}),r(!0)}}catch(i){console.error("Failed to generate QR code:",i),nsSnackBar.error(__("Failed to generate QR code")),f(i)}}),p=()=>{e.popup.close(),e.reject(!1)},x=async()=>{try{const r=await new Promise((f,i)=>{nsHttpClient.get(`/api/user/access/${e.access_id}`).subscribe({next:g=>{g.status==="granted"?nsHttpClient.get(`/api/user/access/${e.access_id}/use`).subscribe({next:()=>{f(!0)},error:O=>{i(!1)}}):console.log("Permission not granted yet, will check again...")},error:g=>{i(!1)}})});e.popup.close(),e.resolve(!0)}catch(r){console.error("Failed to check permission status:",r),p()}};h(()=>{_&&(console.log("Clearing permission status polling interval"),clearInterval(_))});let _=null;return k(async()=>{await C(),await n(),_=window.setInterval(x,2e3),nsHttpClient.get(`/api/permissions/${e.permission}`).subscribe({next:r=>{c.value=r},error:r=>{p(),nsSnackBar.error(__("Failed to load permission data"))}})}),{isLoading:a,qrCodeGenerated:d,permissionData:c,qrCanvas:o,close:p,onUnmounted:h,__,popupCloser,popupResolver}}}),S={class:"bg-white rounded-lg shadow-xl w-[95vw] md:w-[60vw] lg:w-[40vw] w-full max-w-md mx-auto md:max-w-sm lg:max-w-md"},B={class:"flex items-center justify-between p-4 border-b border-gray-200"},j={class:"text-lg font-semibold text-gray-900"},Q={class:"p-6 text-center"},$={class:"mb-6"},D={class:"text-lg font-medium text-gray-900 mb-2"},H={class:"text-sm text-gray-600 mb-4"},N={class:"inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800"},E={class:"mb-6"},F={class:"bg-gray-50 rounded-lg p-4 mb-4"},I={class:"w-[240px] h-[240px] mx-auto bg-white rounded-lg p-2 shadow-inner flex items-center justify-center"},M={class:"w-full h-full bg-gray-100 rounded flex items-center justify-center",ref:"qrCodeContainer"},V={ref:"qrCanvas",class:"max-w-full max-h-full"},z={key:0,class:"text-xs text-gray-500"},A={class:"text-xs text-gray-500 mt-2"};function G(e,t,a,d,o,m){return v(),w("div",S,[s("div",B,[s("h3",j,l(e.__("Permission Required")),1),s("button",{onClick:t[0]||(t[0]=(...c)=>e.close&&e.close(...c)),class:"text-gray-400 hover:text-gray-600 transition-colors"},[...t[1]||(t[1]=[s("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),s("div",Q,[s("div",$,[t[2]||(t[2]=s("div",{class:"w-12 h-12 mx-auto mb-4 bg-yellow-100 rounded-full flex items-center justify-center"},[s("svg",{class:"w-6 h-6 text-yellow-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})])],-1)),s("h4",D,l(e.__("Temporary Permission Required")),1),s("p",H,l(e.__("Access to this feature requires temporary permission from an administrator. Scan the QR code to proceed.")),1),s("div",N,l(e.permissionData.name||e.__("Unknown Permission")),1)]),s("div",E,[s("div",F,[s("div",I,[s("div",M,[s("canvas",V,null,512),e.qrCodeGenerated?P("",!0):(v(),w("div",z,l(e.__("Generating QR...")),1))],512)]),s("p",A,l(e.__("Scan with administrator device")),1)])])])])}const L=q(R,[["render",G],["__scopeId","data-v-a3e00bc7"]]);class K{static async canProceed(t){return new Promise((a,d)=>{const o=POS.options.getValue();if(o.ns_pos_action_permission_enabled==="yes"){const c=o.ns_pos_action_permission_restricted_features;if(o.ns_pos_action_permission_duration,c.includes(t))return nsHttpClient.post("/api/users/check-permission/",{permission:t}).subscribe({next:n=>{a(!0)},error:n=>{n.type&&["permission_denied","permission_pending"].includes(n.type)&&Popup.show(L,{permission:t,access_id:n.data.access.id,resolve:a,reject:d}),n.type==="permission_cooldown"&&nsSnackBar.error(n.message)}})}a(!0)})}}export{K as A};
