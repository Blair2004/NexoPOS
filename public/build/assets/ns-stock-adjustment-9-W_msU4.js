import{n as y,b as h,g as P,P as p}from"./bootstrap-Bo7MKkAU.js";import{n as S}from"./ns-procurement-quantity-DCQhR2Lj.js";import{n as v,d as q,N as x}from"./ns-prompt-popup-Dn8nVVqX.js";import{_ as d}from"./lang-BINodpp-.js";import{n as C}from"./currency-DQAAGb0G.js";import{v as A,w as g}from"./runtime-dom.esm-bundler-BXIQQKg6.js";import{_ as T}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as N,o as l,c as u,a as s,B as U,t as r,F as j,b as k,e as f,i as b,g as V,w,f as L}from"./runtime-core.esm-bundler-CZ21d09l.js";import"./chart-XFVd3zf7.js";const B={name:"ns-stock-adjustment",props:["actions"],data(){return{search:"",timeout:null,suggestions:[],products:[]}},mounted(){},methods:{__:d,nsCurrency:C,searchProduct(e){e.length>0&&y.post("/api/procurements/products/search-procurement-product",{argument:e}).subscribe(t=>{if(t.from==="products")if(t.products.length>0)t.products.length===1?this.addSuggestion(t.products[0]):this.suggestions=t.products;else return this.closeSearch(),h.error(d("Looks like no valid products matched the searched term."));else if(t.from==="procurements"){if(t.product===null)return this.closeSearch(),h.error(d("Looks like no valid products matched the searched term."));this.addProductToList(t.product)}})},addProductToList(e){if(this.products.filter(n=>n.procurement_product_id===e.id).length>0)return this.closeSearch(),h.error(d("The product already exists on the table."));const a=this.actions.filter(n=>n.value==="deleted");let c=a.length===1?a[0]:{value:"deleted"};const i=new Object;e.unit_quantity.unit=e.unit,i.selected=!1,i.quantities=[e.unit_quantity],i.name=e.name,i.adjust_unit=e.unit_quantity,i.adjust_quantity=1,i.adjust_action=c.value,i.adjust_reason="",i.adjust_value=0,i.id=e.product_id,i.accurate_tracking=1,i.available_quantity=e.available_quantity,i.procurement_product_id=e.id,i.procurement_history=[{label:`${e.procurement.name} (${e.available_quantity})`,value:e.id}],this.recalculateProduct(i),this.products.unshift(i),this.clearSearch()},addSuggestion(e){const t=this.products.filter(a=>a.id===e.id).length>0;P([y.get(`/api/products/${e.id}/units/quantities`)]).subscribe(a=>{if(a[0].length>0){const c=a[0].filter(_=>_.unit.base_unit),i=this.actions.filter(_=>_.value==="set");let n=i.length===1?i[0]:{value:"set"};e.selected=!1,e.quantities=a[0],e.adjust_quantity=1,e.adjust_action=n.value,e.adjust_reason="",e.adjust_unit=c.length>0&&!t?c[0]:"",e.adjust_value=0,e.procurement_product_id=0,this.recalculateProduct(e),this.products.unshift(e),this.clearSearch()}else return h.error(d("This product doesn't have any stock to adjust."));e.accurate_tracking})},closeSearch(){this.$refs.searchField.select(),this.suggestions=[]},clearSearch(){this.search="",this.suggestions=[]},recalculateProduct(e){e.adjust_unit!==""&&(["deleted","defective","lost"].includes(e.adjust_action)?e.adjust_value=-(e.adjust_quantity*e.adjust_unit.sale_price):e.adjust_value=e.adjust_quantity*e.adjust_unit.sale_price),this.$forceUpdate()},openQuantityPopup(e){e.quantity,new Promise((a,c)=>{p.show(S,{resolve:a,reject:c,quantity:e.adjust_quantity})}).then(a=>{if(!["added","set"].includes(e.adjust_action)){if(e.accurate_tracking!==void 0&&a.quantity>e.available_quantity)return h.error(d("The specified quantity exceed the available quantity."));if(a.quantity>e.adjust_unit.quantity)return h.error(d("The specified quantity exceed the available quantity."))}e.adjust_quantity=a.quantity,this.recalculateProduct(e)})},proceedStockAdjustment(){if(this.products.length===0)return h.error(d("Unable to proceed as the table is empty."));p.show(v,{title:d("Confirm Your Action"),message:d("The stock adjustment is about to be made. Would you like to confirm ?"),onAction:e=>{e&&y.post("/api/products/adjustments",{products:this.products}).subscribe(t=>{h.success(t.message),this.products=[]},t=>{h.error(t.message)})}})},provideReason(e){new Promise((a,c)=>{p.show(q,{title:d("More Details"),resolve:a,reject:c,message:d("Useful to describe better what are the reasons that leaded to this adjustment."),input:e.adjust_reason,onAction:i=>{i!==!1&&(e.adjust_reason=i)}})}).then(a=>{h.success(d("The reason has been updated.")).susbcribe()}).catch(a=>{})},async selectAdjustmentUnit(e){try{const t=await new Promise((n,_)=>{p.show(x,{label:d("Select Unit"),resolve:n,reject:_,description:d("Select the unit that you want to adjust the stock with."),name:"adjust_unit",options:e.quantities.map(o=>({label:o.unit.name,value:o}))})}),a=this.products.indexOf(e);if(this.products.filter((n,_)=>_!==a).filter(n=>n.adjust_unit.unit.id===t.unit.id&&n.adjust_unit.product_id===t.product_id).length>0)return h.error(d("A similar product with the same unit already exists."));e.adjust_unit=t,this.recalculateProduct(e)}catch{}},async selectProcurement(e){try{console.log(e);const t=await new Promise((a,c)=>{p.show(x,{label:d("Select Procurement"),resolve:a,reject:c,description:d("Select the procurement that you want to adjust the stock with."),name:"adjust_procurement",options:e.procurement_history})});e.procurement_product_id=t,this.recalculateProduct(e)}catch(t){throw t}},async selectStockAdjustementAction(e){try{const t=await new Promise((a,c)=>{p.show(x,{label:d("Select Action"),resolve:a,reject:c,description:d("Select the action that you want to perform on the stock."),name:"adjust_action",options:this.actions})});e.adjust_action=t}catch(t){throw t}},removeProduct(e){p.show(v,{title:d("Confirm Your Action"),message:d("Would you like to remove this product from the table ?"),onAction:t=>{if(t){const a=this.products.indexOf(e);this.products.splice(a,1)}}})},getAdjustActionLabel(e){const t=this.actions.filter(a=>a.value===e);return t.length>0?t[0].label:d("N/A")},deleteSelectedProducts(){p.show(v,{title:d("Confirm Your Action"),message:d("Would you like to remove the selected products from the table ?"),onAction:e=>{e&&(this.products=this.products.filter(t=>!t.selected))}})}},watch:{search(){this.search.length>0?(clearTimeout(this.timeout),this.timeout=setTimeout(()=>{this.searchProduct(this.search)},500)):this.closeSearch()}}},Q={class:"input-field flex border-2 input-group rounded"},R={class:"px-3 py-2 rounded-none"},F={key:0,class:"h-0"},O={class:""},D={class:"shadow h-96 relative z-10 ns-vertical-menu zoom-in-entrance anim-duration-300 overflow-y-auto"},W=["onClick"],Y={class:"ns-box rounded shadow my-2 w-full"},z={class:"table w-full ns-table"},K={class:"border-b"},M={class:"p-2"},E={width:"120",class:"p-2 text-center hidden md:table-cell"},H={width:"120",class:"p-2 text-center hidden md:table-cell"},J={key:0},G={class:"p-2 border-b text-center hidden md:table-cell",colspan:"6"},I={class:"p-2 border-b text-center table-cell md:hidden",colspan:"4"},X={class:"p-2 border"},Z={class:"flex justify-between"},$=["onClick"],ee=["checked"],te=["onClick"],se={class:"flex -mx-2 md:flex-row flex-wrap"},ne=["onClick"],oe={class:"text-xs cursor-pointer border-b border-dashed border-info-secondary py-1"},ie={class:"text-xs"},ae={key:0,class:""},re={key:1},de=["onClick"],ce={class:"text-xs cursor-pointer border-b border-dashed border-info-secondary py-1"},le={class:"text-xs"},ue={class:""},he=["onClick"],_e={class:"text-xs cursor-pointer border-b border-dashed border-info-secondary py-1"},me={class:"text-xs"},pe={class:""},fe=["onClick"],be={class:"text-xs cursor-pointer border-b border-dashed border-info-secondary py-1"},ye={class:"text-xs"},ve={key:0},xe={key:1},je=["onClick"],ke={class:"text-xs cursor-pointer border-b border-dashed border-danger-secondary py-1"},we={class:"text-xs"},Pe=["onClick"],Se={class:"flex items-center justify-center cursor-pointer"},qe={class:"border-b border-dashed border-info-secondary py-2 px-4"},Ce={class:"p-2 border hidden md:table-cell"},Ae={class:"flex items-center justify-center"},ge={class:"border-b border-dashed border-info-secondary py-2 px-4"},Te={class:"ns-box-footer p-2 flex justify-end"},Ne={class:"-mx-2 flex"},Ue={class:"px-2"},Ve={class:"hidden md:inline-block"},Le={class:"px-2"};function Be(e,t,a,c,i,n){const _=N("ns-button");return l(),u("div",null,[s("div",Q,[U(s("input",{onKeyup:t[0]||(t[0]=g(o=>n.closeSearch(),["esc"])),ref:"searchField","onUpdate:modelValue":t[1]||(t[1]=o=>i.search=o),type:"text",class:"p-2 flex-auto outline-hidden"},null,544),[[A,i.search]]),s("button",R,r(n.__("Search")),1)]),i.suggestions.length>0?(l(),u("div",F,[s("div",O,[s("ul",D,[(l(!0),u(j,null,k(i.suggestions,o=>(l(),u("li",{onClick:m=>n.addSuggestion(o),key:o.id,class:"cursor-pointer border-b p-2 flex justify-between"},[s("span",null,r(o.name),1)],8,W))),128))])])])):f("",!0),s("div",Y,[s("table",z,[s("thead",K,[s("tr",null,[s("td",M,r(n.__("Product")),1),s("td",E,r(n.__("Quantity")),1),s("td",H,r(n.__("Value")),1)])]),s("tbody",null,[i.products.length===0?(l(),u("tr",J,[s("td",G,r(n.__("Search and add some products")),1),s("td",I,r(n.__("Search and add some products")),1)])):f("",!0),(l(!0),u(j,null,k(i.products,o=>(l(),u("tr",{key:o.id},[s("td",X,[s("div",Z,[s("div",null,[s("h3",{class:"font-bold cursor-pointer",onClick:m=>o.selected=!o.selected},[s("input",{type:"checkbox",checked:o.selected,name:"",id:""},null,8,ee),b(" "+r(o.name)+" ("+r((o.accurate_tracking===1?o.available_quantity:o.adjust_unit.quantity)||0)+")",1)],8,$)]),s("div",null,[s("span",{class:"md:hidden cursor-pointer border-dashed border-b border-info-secondary",onClick:m=>n.openQuantityPopup(o)},r(n.__("Quantity"))+" : "+r(o.adjust_quantity),9,te)])]),s("div",se,[s("div",{class:"px-2 w-1/2 md:w-auto",onClick:m=>n.selectAdjustmentUnit(o)},[s("div",oe,[s("span",ie,r(n.__("Unit:")),1),t[4]||(t[4]=b("  ")),o.adjust_unit.unit?(l(),u("span",ae,r(o.adjust_unit.unit.name),1)):f("",!0),o.adjust_unit.unit?f("",!0):(l(),u("span",re,r(n.__("N/A")),1))])],8,ne),s("div",{class:"px-2 w-1/2 md:w-auto",onClick:m=>n.selectStockAdjustementAction(o)},[s("div",ce,[s("span",le,r(n.__("Operation:")),1),t[5]||(t[5]=b("  ")),s("span",ue,r(n.getAdjustActionLabel(o.adjust_action)),1)])],8,de),o.accurate_tracking===1?(l(),u("div",{key:0,class:"px-2 w-1/2 md:w-auto",onClick:m=>n.selectProcurement(o)},[s("div",_e,[s("span",me,r(n.__("Procurement:")),1),t[6]||(t[6]=b("  ")),s("span",pe,r(o.procurement_history.filter(m=>m.value===o.procurement_product_id)[0].label),1)])],8,he)):f("",!0),s("div",{class:"px-2 w-1/2 md:w-auto",onClick:m=>n.provideReason(o)},[s("div",be,[s("span",ye,r(n.__("Reason:")),1),t[7]||(t[7]=b("  ")),o.adjust_reason?(l(),u("span",ve,r(n.__("Provided")),1)):(l(),u("span",xe,r(n.__("Not Provided")),1))])],8,fe),s("div",{class:"px-2 w-1/2 md:w-auto",onClick:m=>n.removeProduct(o)},[s("div",ke,[s("span",we,r(n.__("Remove")),1)])],8,je)])]),s("td",{class:"p-2 border hidden md:table-cell",onClick:m=>n.openQuantityPopup(o)},[s("div",Se,[s("span",qe,r(o.adjust_quantity),1)])],8,Pe),s("td",Ce,[s("div",Ae,[s("span",ge,r(n.nsCurrency(o.adjust_value)),1)])])]))),128))])]),s("div",Te,[s("div",Ne,[s("div",Ue,[i.products.filter(o=>o.selected).length>0?(l(),V(_,{key:0,onClick:t[2]||(t[2]=o=>n.deleteSelectedProducts()),type:"error"},{default:w(()=>[t[8]||(t[8]=s("div",{class:"flex items-center justify-center h-6"},[s("i",{class:"las la-trash"})],-1)),s("span",Ve,r(n.__("Remove Selected")),1)]),_:1})):f("",!0)]),s("div",Le,[L(_,{onClick:t[3]||(t[3]=o=>n.proceedStockAdjustment()),type:"info"},{default:w(()=>[b(r(n.__("Proceed")),1)]),_:1})])])])])])}const Me=T(B,[["render",Be]]);export{Me as default};
