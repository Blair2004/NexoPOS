import{n as y,a as l,P as b}from"./bootstrap-4befc3ba.js";import{n as w}from"./ns-procurement-quantity-f64edfbe.js";import k from"./ns-pos-confirm-popup-47015db9.js";import q from"./ns-prompt-popup-64b67141.js";import{_ as c,n as g}from"./currency-47ec5b79.js";import{m as P,w as C,l as v}from"./npm~@vue~runtime-dom_-a668b91e.js";import{_ as S}from"./_plugin-vue_export-helper-c27b6911.js";import{f as V}from"./npm~rxjs-a7e91008.js";import{ae as T,a6 as u,z as d,A as t,az as f,F as m,ac as p,y as j,c as U,ax as A,H as L}from"./npm~@vue~runtime-core_-ff0bdc0c.js";import{U as r}from"./npm~@vue~shared_-82b01912.js";import"./npm~lodash-f7a36ac5.js";import"./npm~@ckeditor~ckeditor5-build-classic_-a8abd726.js";import"./npm~laravel-echo-7ac8f47a.js";import"./npm~pusher-js-7b18aad5.js";import"./npm~axios-4a70c6fc.js";import"./npm~chart.js-3fed1729.js";import"./npm~moment-fbc5633a.js";import"./npm~vue-6a0d7c4c.js";import"./npm~@vue~compiler-dom_-04241bb4.js";import"./npm~@vue~compiler-core_-2a2ce8c7.js";import"./npm~@vue~reactivity_-481192b6.js";import"./npm~rx-1641e2f8.js";import"./npm~@wordpress~hooks_-18172e20.js";import"./npm~mathjs-1dff8408.js";import"./npm~@babel~runtime_-34ca84e8.js";import"./npm~decimal.js-d133ee8e.js";import"./npm~complex.js-15c479db.js";import"./npm~fraction.js-52b397f9.js";import"./npm~typed-function-e88d1f37.js";import"./npm~seedrandom-b246f2f9.js";import"./npm~javascript-natural-sort-11e7fc54.js";import"./npm~escape-latex-404addb9.js";import"./npm~tslib-f3101d7c.js";import"./npm~numeral-faf61dd1.js";import"./npm~currency.js-57f74176.js";const z={name:"ns-stock-adjustment",props:["actions"],data(){return{search:"",timeout:null,suggestions:[],products:[]}},mounted(){},methods:{__:c,nsCurrency:g,searchProduct(e){e.length>0&&y.post("/api/procurements/products/search-procurement-product",{argument:e}).subscribe(o=>{if(o.from==="products")if(o.products.length>0)o.products.length===1?this.addSuggestion(o.products[0]):this.suggestions=o.products;else return this.closeSearch(),l.error(c("Looks like no products matched the searched term.")).subscribe();else if(o.from==="procurements"){if(o.product===null)return this.closeSearch(),l.error(c("Looks like no products matched the searched term.")).subscribe();this.addProductToList(o.product)}})},addProductToList(e){if(this.products.filter(h=>h.procurement_product_id===e.id).length>0)return this.closeSearch(),l.error(c("The product already exists on the table.")).subscribe();const n=new Object;e.unit_quantity.unit=e.unit,n.quantities=[e.unit_quantity],n.name=e.name,n.adjust_unit=e.unit_quantity,n.adjust_quantity=1,n.adjust_action="",n.adjust_reason="",n.adjust_value=0,n.id=e.product_id,n.accurate_tracking=1,n.available_quantity=e.available_quantity,n.procurement_product_id=e.id,n.procurement_history=[{label:`${e.procurement.name} (${e.available_quantity})`,value:e.id}],this.products.push(n),this.closeSearch()},addSuggestion(e){V([y.get(`/api/products/${e.id}/units/quantities`)]).subscribe(o=>{if(o[0].length>0)e.quantities=o[0],e.adjust_quantity=1,e.adjust_action="",e.adjust_reason="",e.adjust_unit="",e.adjust_value=0,e.procurement_product_id=0,this.products.push(e),this.closeSearch();else return l.error(c("This product does't have any stock to adjust.")).subscribe();e.accurate_tracking})},closeSearch(){this.search="",this.suggestions=[]},recalculateProduct(e){e.adjust_unit!==""&&(["deleted","defective","lost"].includes(e.adjust_action)?e.adjust_value=-(e.adjust_quantity*e.adjust_unit.sale_price):e.adjust_value=e.adjust_quantity*e.adjust_unit.sale_price),this.$forceUpdate()},openQuantityPopup(e){e.quantity,new Promise((n,h)=>{b.show(w,{resolve:n,reject:h,quantity:e.adjust_quantity})}).then(n=>{if(!["added"].includes(e.adjust_action)){if(e.accurate_tracking!==void 0&&n.quantity>e.available_quantity)return l.error(c("The specified quantity exceed the available quantity.")).subscribe();if(n.quantity>e.adjust_unit.quantity)return l.error(c("The specified quantity exceed the available quantity.")).subscribe()}e.adjust_quantity=n.quantity,this.recalculateProduct(e)})},proceedStockAdjustment(){if(this.products.length===0)return l.error(c("Unable to proceed as the table is empty.")).subscribe();b.show(k,{title:c("Confirm Your Action"),message:c("The stock adjustment is about to be made. Would you like to confirm ?"),onAction:e=>{e&&y.post("/api/products/adjustments",{products:this.products}).subscribe(o=>{l.success(o.message).subscribe(),this.products=[]},o=>{l.error(o.message).subscribe()})}})},provideReason(e){new Promise((n,h)=>{b.show(q,{title:c("More Details"),resolve:n,reject:h,message:c("Useful to describe better what are the reasons that leaded to this adjustment."),input:e.adjust_reason,onAction:_=>{_!==!1&&(e.adjust_reason=_)}})}).then(n=>{l.success(c("The reason has been updated.")).susbcribe()}).catch(n=>{})},removeProduct(e){b.show(k,{title:c("Confirm Your Action"),message:c("Would you like to remove this product from the table ?"),onAction:o=>{if(o){const n=this.products.indexOf(e);this.products.splice(n,1)}}})}},watch:{search(){this.search.length>0?(clearTimeout(this.timeout),this.timeout=setTimeout(()=>{this.searchProduct(this.search)},500)):this.closeSearch()}}},B={class:"input-field flex border-2 input-group rounded"},N={class:"px-3 py-2 rounded-none"},Q={key:0,class:"h-0"},D={class:""},M={class:"shadow h-96 relative z-10 ns-vertical-menu zoom-in-entrance anim-duration-300 overflow-y-auto"},O=["onClick"],F={class:"ns-box rounded shadow my-2 w-full"},H={class:"table w-full ns-table"},K={class:"border-b"},R={class:"p-2"},W={width:"120",class:"p-2 text-center"},Y={width:"120",class:"p-2 text-center"},E={width:"120",class:"p-2 text-center"},J={width:"120",class:"p-2 text-center"},G={width:"120",class:"p-2 text-center"},I={width:"150",class:"p-2 text-center"},X={key:0},Z={class:"p-2 text-center",colspan:"6"},$={class:"p-2"},ee={class:"p-2"},te={class:"input-group border-2 info"},se=["onChange","onUpdate:modelValue"],oe=["value"],ne={class:"p-2"},ie={class:"input-group border-2 info"},ae=["onChange","onUpdate:modelValue"],re=["value"],ce={class:"p-2"},ue={key:0,class:"input-group border-2 info"},de=["onChange","onUpdate:modelValue"],le=["value"],_e=["onClick"],he={class:"border-b border-dashed border-blue-400 py-2 px-4"},me={class:"p-2"},pe={class:"border-b border-dashed border-blue-400 py-2 px-4"},be={class:"p-2"},fe={class:"-mx-1 flex justify-end"},ye={class:"px-1"},ve=["onClick"],je=t("i",{class:"las la-comment-dots"},null,-1),ke=[je],xe={class:"px-1"},we=["onClick"],qe=t("i",{class:"las la-times"},null,-1),ge=[qe],Pe={class:"border-t ns-box-footer p-2 flex justify-end"};function Ce(e,o,n,h,_,a){const x=T("ns-button");return u(),d("div",null,[t("div",B,[f(t("input",{onKeyup:o[0]||(o[0]=C(s=>a.closeSearch(),["esc"])),"onUpdate:modelValue":o[1]||(o[1]=s=>_.search=s),type:"text",class:"p-2 flex-auto outline-none"},null,544),[[P,_.search]]),t("button",N,r(a.__("Search")),1)]),_.suggestions.length>0?(u(),d("div",Q,[t("div",D,[t("ul",M,[(u(!0),d(m,null,p(_.suggestions,s=>(u(),d("li",{onClick:i=>a.addSuggestion(s),key:s.id,class:"cursor-pointer border-b p-2 flex justify-between"},[t("span",null,r(s.name),1)],8,O))),128))])])])):j("",!0),t("div",F,[t("table",H,[t("thead",K,[t("tr",null,[t("td",R,r(a.__("Product")),1),t("td",W,r(a.__("Unit")),1),t("td",Y,r(a.__("Operation")),1),t("td",E,r(a.__("Procurement")),1),t("td",J,r(a.__("Quantity")),1),t("td",G,r(a.__("Value")),1),t("td",I,r(a.__("Actions")),1)])]),t("tbody",null,[_.products.length===0?(u(),d("tr",X,[t("td",Z,r(a.__("Search and add some products")),1)])):j("",!0),(u(!0),d(m,null,p(_.products,s=>(u(),d("tr",{key:s.id},[t("td",$,r(s.name)+" ("+r((s.accurate_tracking===1?s.available_quantity:s.adjust_unit.quantity)||0)+")",1),t("td",ee,[t("div",te,[f(t("select",{onChange:i=>a.recalculateProduct(s),"onUpdate:modelValue":i=>s.adjust_unit=i,class:"outline-none p-2 w-full"},[(u(!0),d(m,null,p(s.quantities,i=>(u(),d("option",{key:i.id,value:i},r(i.unit.name),9,oe))),128))],40,se),[[v,s.adjust_unit]])])]),t("td",ne,[t("div",ie,[f(t("select",{onChange:i=>a.recalculateProduct(s),"onUpdate:modelValue":i=>s.adjust_action=i,name:"",id:"",class:"outline-none p-2 w-full"},[(u(!0),d(m,null,p(n.actions,i=>(u(),d("option",{key:i.value,value:i.value},r(i.label),9,re))),128))],40,ae),[[v,s.adjust_action]])])]),t("td",ce,[s.accurate_tracking===1?(u(),d("div",ue,[f(t("select",{onChange:i=>a.recalculateProduct(s),"onUpdate:modelValue":i=>s.procurement_product_id=i,name:"",id:"",class:"outline-none p-2 bg-white w-full"},[(u(!0),d(m,null,p(s.procurement_history,i=>(u(),d("option",{key:i.value,value:i.value},r(i.label),9,le))),128))],40,de),[[v,s.procurement_product_id]])])):j("",!0)]),t("td",{class:"p-2 flex items-center justify-center cursor-pointer",onClick:i=>a.openQuantityPopup(s)},[t("span",he,r(s.adjust_quantity),1)],8,_e),t("td",me,[t("span",pe,r(a.nsCurrency(s.adjust_value)),1)]),t("td",be,[t("div",fe,[t("div",ye,[t("button",{onClick:i=>a.provideReason(s),class:"ns-inset-button active info border outline-none rounded-full shadow h-10 w-10"},ke,8,ve)]),t("div",xe,[t("button",{onClick:i=>a.removeProduct(s),class:"ns-inset-button active error border outline-none rounded-full shadow h-10 w-10"},ge,8,we)])])])]))),128))])]),t("div",Pe,[U(x,{onClick:o[2]||(o[2]=s=>a.proceedStockAdjustment()),type:"info"},{default:A(()=>[L(r(a.__("Proceed")),1)]),_:1})])])])}const ut=S(z,[["render",Ce]]);export{ut as default};
