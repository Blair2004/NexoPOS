const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./ns-pos-dashboard-button-D2hKHzyk.js","./currency-B1QCtbGi.js","./_plugin-vue_export-helper-DlAUqK2U.js","./runtime-core.esm-bundler-Bzup5G8m.js","./ns-pos-pending-orders-button-B9WVGtMo.js","./bootstrap-BLn7iW8g.js","./chart-XFVd3zf7.js","./ns-prompt-popup-DdPqD7fR.js","./ns-prompt-popup-HgmDB_Gf.css","./ns-pos-order-type-button-CUGXSXz7.js","./ns-pos-shipping-popup-Bl6_-1CV.js","./ns-orders-preview-popup-CcpgnHEu.js","./ns-pos-customers-button-CAhxMm26.js","./ns-pos-reset-button-C7IIA6Fy.js","./ns-pos-registers-button-yVpibaoH.js"])))=>i.map(i=>d[i]);
var X=Object.defineProperty;var Z=(r,e,t)=>e in r?X(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var x=(r,e,t)=>Z(r,typeof e!="symbol"?e+"":e,t);import{_ as Q}from"./preload-helper-D6kgxu3v.js";import{n as ee,a as te,b as se,c as z,P as ie}from"./ns-pos-shipping-popup-Bl6_-1CV.js";import{p as ne,a as G,b as k,d as _,P as w,F as re,e as oe,n as b,B as P,f as H,T as M,g,h as ae}from"./bootstrap-BLn7iW8g.js";import{_ as c,n as V,a as I}from"./currency-B1QCtbGi.js";import{_ as A}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as T,o as p,c as m,a as o,t as d,F as j,b as q,e as f,f as C,n as E,g as F,w as O,h as le,i as S,j as ue,d as U}from"./runtime-core.esm-bundler-Bzup5G8m.js";import{n as $,a as ce,N as de,b as B,c as pe,d as me}from"./ns-prompt-popup-DdPqD7fR.js";import"./ns-orders-preview-popup-CcpgnHEu.js";import"./chart-XFVd3zf7.js";const he={props:["popup"],data(){return{unitsQuantities:[],loadsUnits:!1,options:null,optionsSubscriber:null}},beforeDestroy(){this.optionsSubscriber.unsubscribe()},mounted(){this.optionsSubscriber=POS.options.subscribe(r=>{this.options=r}),this.popup.params.product.$original().selectedUnitQuantity!==void 0?this.selectUnit(this.popup.params.product.$original().selectedUnitQuantity):this.popup.params.product.$original().unit_quantities!==void 0&&this.popup.params.product.$original().unit_quantities.length===1?this.selectUnit(this.popup.params.product.$original().unit_quantities[0]):(this.loadsUnits=!0,this.loadUnits()),this.popupCloser()},computed:{productName(){return this.popup.params.product.$original().name}},methods:{__:c,nsCurrency:V,popupCloser:ne,popupResolver:G,displayRightPrice(r){return POS.getSalePrice(r,this.popup.params.product.$original())},loadUnits(){k.get(`/api/products/${this.popup.params.product.$original().id}/units/quantities`).subscribe(r=>{if(r.length===0)return this.popup.close(),_.error(c("This product doesn't have any unit defined for selling. Make sure to mark at least one unit as visible.")).subscribe();this.unitsQuantities=r,this.unitsQuantities.length===1&&this.selectUnit(this.unitsQuantities[0])})},selectUnit(r){if(r.unit===null)return _.error(c('The unit attached to this product is missing or not assigned. Please review the "Unit" tab for this product.')).subscribe(),this.popup.close();this.popup.params.resolve({unit_quantity_id:r.id,unit_name:r.unit.name,$quantities:()=>r}),this.popup.close()}}},_e={class:"h-full w-full flex items-center justify-center",id:"ns-units-selector"},fe={key:0,class:"ns-box w-4/5-screen lg:w-1/3-screen overflow-hidden flex flex-col"},ye={id:"header",class:"h-16 flex justify-center items-center flex-shrink-0"},xe={class:"font-bold text-primary"},be={key:0,class:"grid grid-flow-row grid-cols-2 overflow-y-auto"},ge=["onClick"],we={class:"h-40 w-full flex items-center justify-center overflow-hidden"},ve=["src","alt"],Pe={key:1,class:"h-40 flex items-center justify-center"},ke={class:"h-0 w-full"},Ce={class:"relative w-full flex items-center justify-center -top-10 h-20 py-2 flex-col overlay"},Ve={class:"font-bold text-primary py-2 text-center"},Te={class:"text-sm font-medium text-primary"},Se={key:1,class:"h-56 flex items-center justify-center"};function Oe(r,e,t,s,i,n){const a=T("ns-spinner");return p(),m("div",_e,[i.unitsQuantities.length>0?(p(),m("div",fe,[o("div",ye,[o("h3",xe,d(n.__("{product} : Units").replace("{product}",n.productName)),1)]),i.unitsQuantities.length>0?(p(),m("div",be,[(p(!0),m(j,null,q(i.unitsQuantities,l=>(p(),m("div",{onClick:u=>n.selectUnit(l),key:l.id,class:"ns-numpad-key info cursor-pointer border flex-shrink-0 flex flex-col items-center justify-center"},[o("div",we,[l.preview_url?(p(),m("img",{key:0,src:l.preview_url,class:"object-cover h-full",alt:l.unit.name},null,8,ve)):f("",!0),l.preview_url?f("",!0):(p(),m("div",Pe,e[0]||(e[0]=[o("i",{class:"las la-image text-primary text-6xl"},null,-1)])))]),o("div",ke,[o("div",Ce,[o("h3",Ve,d(l.unit.name)+" ("+d(l.quantity)+")",1),o("p",Te,d(n.nsCurrency(n.displayRightPrice(l))),1)])])],8,ge))),128))])):f("",!0)])):f("",!0),i.unitsQuantities.length===0?(p(),m("div",Se,[C(a)])):f("",!0)])}const Ae=A(he,[["render",Oe]]);class Fe{constructor(e){this.product=e}run(){return new Promise((e,t)=>{const s=this.product;w.show(Ae,{resolve:e,reject:t,product:s})})}}class D{constructor(e){this.order=e}run(){return new Promise((e,t)=>this.order.customer===void 0?w.show(ee,{resolve:e,reject:t}):e(!0))}}window.CustomerQueue=D;const je={name:"sample-payment",props:["label","identifier"],data(){return{backValue:"0",number:parseInt(1+new Array(parseInt(ns.currency.ns_currency_precision)).fill("").map(r=>0).join("")),order:null,settings:{},settingsSubscription:null,cursor:parseInt(ns.currency.ns_currency_precision),orderSubscription:null,allSelected:!0,keys:[...[7,8,9].map(r=>({identifier:r,value:r})),...[4,5,6].map(r=>({identifier:r,value:r})),...[1,2,3].map(r=>({identifier:r,value:r})),{identifier:"backspace",icon:"la-backspace"},{identifier:0,value:0},{identifier:"next",icon:"la-share"}]}},computed:{amountShortcuts(){return nsShortcuts.ns_pos_amount_shortcut!==null?nsShortcuts.ns_pos_amount_shortcut.split("|"):[]}},mounted(){this.orderSubscription=POS.order.subscribe(e=>{this.order=e}),this.settingsSubscription=POS.settings.subscribe(e=>{this.settings=e});const r=new Array(10).fill("").map((e,t)=>t);nsHotPress.create("numpad-keys").whenVisible([".is-popup"]).whenPressed(r,(e,t)=>{this.inputValue({value:t})}),nsHotPress.create("numpad-backspace").whenVisible([".is-popup"]).whenPressed("backspace",()=>this.inputValue({identifier:"backspace"})),nsHotPress.create("numpad-save").whenVisible([".is-popup"]).whenPressed("enter",()=>{this.backValue===""?(this.$emit("submit"),this.backValue=0):this.inputValue({identifier:"next"})})},beforeDestroy(){nsHotPress.destroy("numpad-keys"),nsHotPress.destroy("numpad-backspace"),nsHotPress.destroy("numpad-save")},unmounted(){this.orderSubscription.unsubscribe()},methods:{__:c,nsCurrency:V,toggleDiscount(){if(this.settings.cart_discount!==void 0&&this.settings.cart_discount===!0)w.show(te,{reference:this.order,type:"cart",onSubmit:r=>{POS.updateCart(this.order,r)}});else return _.error(c("You're not allowed to add a discount on the cart.")).subscribe()},makeFullPayment(){POS.order.getValue(),w.show($,{title:c("Confirm Full Payment"),message:c("A full payment will be made using {paymentType} for {total}").replace("{paymentType}",this.label).replace("{total}",V(this.order.total)),onAction:r=>{if(r){const e=POS.order.getValue();e.tendered<e.total&&POS.addPayment({value:this.order.total-e.tendered,identifier:this.identifier,selected:!1,label:this.label,readonly:!1}),this.$emit("submit"),this.backValue="0"}}})},increaseBy(r){let e=parseInt(1+new Array(this.cursor).fill("").map(t=>0).join(""));this.backValue=(parseFloat(r.value)*e+(parseFloat(this.backValue)||0)).toString(),this.allSelected=!1},inputValue(r){r.identifier==="next"?(POS.addPayment({value:parseFloat(this.backValue/this.number),identifier:this.identifier,selected:!1,label:this.label,readonly:!1}),this.backValue="0"):r.identifier==="backspace"?this.allSelected?(this.backValue="0",this.allSelected=!1):this.backValue=this.backValue.slice(0,-1):r.value.toString().match(/^\d+$/)&&(this.allSelected?(this.backValue=r.value.toString(),this.allSelected=!1):(this.backValue+=r.value.toString(),this.mode==="percentage"&&(this.backValue=this.backValue>100?100:this.backValue))),this.backValue==="0"&&(this.backValue="")}}},qe={class:"h-full w-full py-2"},Ie={key:0,class:"px-2 pb-2"},Qe={class:"grid grid-cols-2 gap-2"},Ue={id:"details",class:"h-16 flex justify-between items-center border elevation-surface info text-xl md:text-3xl p-2"},$e={id:"paid",class:"h-16 flex justify-between items-center border elevation-surface success text-xl md:text-3xl p-2"},Re={id:"change",class:"h-16 flex justify-between items-center border elevation-surface warning text-xl md:text-3xl p-2"},Ee={id:"change",class:"col-span-2 h-16 flex justify-between items-center elevation-surface border text-xl md:text-3xl p-2"},Be={class:"px-2 pb-2"},De={class:"-mx-2 flex flex-wrap"},Le={class:"pl-2 pr-1 flex-auto"},We={id:"numpad",class:"grid grid-flow-row grid-cols-3 gap-2 grid-rows-3",style:{padding:"1px"}},Ne=["onClick"],Ye={key:0},He={class:"w-1/2 md:w-72 pr-2 pl-1"},Me={class:"grid grid-flow-row grid-rows-1 gap-2"},ze=["onClick"];function Ge(r,e,t,s,i,n){return p(),m("div",qe,[i.order?(p(),m("div",Ie,[o("div",Qe,[o("div",Ue,[o("span",null,d(n.__("Total"))+" : ",1),o("span",null,d(n.nsCurrency(i.order.total)),1)]),o("div",{id:"discount",onClick:e[0]||(e[0]=a=>n.toggleDiscount()),class:"cursor-pointer h-16 flex justify-between items-center border elevation-surface error text-xl md:text-3xl p-2"},[o("span",null,d(n.__("Discount"))+" : ",1),o("span",null,d(n.nsCurrency(i.order.discount)),1)]),o("div",$e,[o("span",null,d(n.__("Paid"))+" : ",1),o("span",null,d(n.nsCurrency(i.order.tendered)),1)]),o("div",Re,[o("span",null,d(n.__("Change"))+" : ",1),o("span",null,d(n.nsCurrency(i.order.change)),1)]),o("div",Ee,[o("span",null,d(n.__("Screen"))+" : ",1),o("span",null,d(n.nsCurrency(i.backValue/i.number)),1)])])])):f("",!0),o("div",Be,[o("div",De,[o("div",Le,[o("div",We,[(p(!0),m(j,null,q(i.keys,(a,l)=>(p(),m("div",{onClick:u=>n.inputValue(a),key:l,style:{margin:"-1px"},class:"ns-numpad-key text-2xl border h-16 flex items-center justify-center cursor-pointer"},[a.value!==void 0?(p(),m("span",Ye,d(a.value),1)):f("",!0),a.icon?(p(),m("i",{key:1,class:E(["las",a.icon])},null,2)):f("",!0)],8,Ne))),128)),o("div",{onClick:e[1]||(e[1]=a=>n.makeFullPayment()),class:"hover:bg-green-500 col-span-3 bg-success-secondary border-success-tertiary text-2xl text-white border h-16 flex items-center justify-center cursor-pointer"},d(n.__("Full Payment")),1)])]),o("div",He,[o("div",Me,[(p(!0),m(j,null,q(n.amountShortcuts,(a,l)=>(p(),m("div",{key:l,onClick:u=>n.increaseBy({value:a}),class:"ns-numpad-key text-2xl border h-16 flex items-center justify-center cursor-pointer"},[o("span",null,d(n.nsCurrency(a)),1)],8,ze))),128))])])])])])}const L=A(je,[["render",Ge]]),Ke={name:"cash-payment",props:["identifier","label"],components:{samplePayment:L}};function Je(r,e,t,s,i,n){const a=T("sample-payment");return p(),F(a,{identifier:t.identifier,label:t.label},null,8,["identifier","label"])}const Xe=A(Ke,[["render",Je]]),Ze={name:"creditcart-payment",props:["identifier"]};function et(r,e,t,s,i,n){return p(),m("h1",null,"Credit Card")}const tt=A(Ze,[["render",et]]),st={name:"bank-payment",props:["identifier","label"],components:{samplePayment:L}};function it(r,e,t,s,i,n){const a=T("sample-payment");return p(),F(a,{identifier:t.identifier,label:t.label},null,8,["identifier","label"])}const nt=A(st,[["render",it]]),rt={name:"ns-account-payment",components:{nsNumpad:ce},props:["identifier","label"],data(){return{subscription:null,screenValue:0,order:null}},methods:{__:c,nsCurrency:V,handleChange(r){this.screenValue=r},proceedAddingPayment(r){const e=parseFloat(r),t=this.order.payments;if(e<=0)return _.error(c("Please provide a valid payment amount.")).subscribe();if(t.filter(s=>s.identifier==="account-payment").length>0)return _.error(c("The customer account can only be used once per order. Consider deleting the previously used payment.")).subscribe();if(e>this.order.customer.account_amount)return _.error(c("Not enough funds to add {amount} as a payment. Available balance {balance}.").replace("{amount}",V(e)).replace("{balance}",V(this.order.customer.account_amount))).subscribe();POS.addPayment({value:e,identifier:"account-payment",selected:!1,label:this.label,readonly:!1}),this.order.customer.account_amount-=e,POS.selectCustomer(this.order.customer)},proceedFullPayment(){if(this.order.payments.filter(e=>e.identifier==="account-payment").length>0)return _.error(c("The customer account can only be used once per order. Consider deleting the previously used payment.")).subscribe();this.proceedAddingPayment(this.order.total),this.$emit("submit")},makeFullPayment(){Popup.show($,{title:c("Confirm Full Payment"),message:c("You're about to use {amount} from the customer account to make a payment. Would you like to proceed ?").replace("{amount}",V(this.order.total)),onAction:r=>{r&&this.proceedFullPayment()}})}},mounted(){this.subscription=POS.order.subscribe(r=>this.order=r)},unmounted(){this.subscription.unsubscribe()}},ot={class:"h-full w-full py-2"},at={key:0,class:"px-2 pb-2"},lt={class:"grid grid-cols-2 gap-2"},ut={id:"details",class:"h-16 flex justify-between items-center elevation-surface border info text-xl md:text-3xl p-2"},ct={id:"paid",class:"h-16 flex justify-between items-center elevation-surface success border text-xl md:text-3xl p-2"},dt={id:"change",class:"h-16 flex justify-between items-center elevation-surface warning border text-xl md:text-3xl p-2"},pt={id:"change",class:"col-span-2 h-16 flex justify-between items-center elevation-surface border success text-xl md:text-3xl p-2"},mt={id:"change",class:"col-span-2 h-16 flex justify-between items-center elevation-surface border text-primary text-xl md:text-3xl p-2"},ht={class:"px-2 pb-2"},_t={class:"-mx-2 flex flex-wrap"},ft={class:"pl-2 pr-1 flex-auto"},yt={class:"w-1/2 md:w-72 pr-2 pl-1"},xt={class:"grid grid-flow-row grid-rows-1 gap-2"};function bt(r,e,t,s,i,n){const a=T("ns-numpad");return p(),m("div",ot,[i.order?(p(),m("div",at,[o("div",lt,[o("div",ut,[o("span",null,d(n.__("Total"))+" : ",1),o("span",null,d(n.nsCurrency(i.order.total)),1)]),o("div",{id:"discount",onClick:e[0]||(e[0]=l=>r.toggleDiscount()),class:"cursor-pointer h-16 flex justify-between items-center elevation-surface error border text-xl md:text-3xl p-2"},[o("span",null,d(n.__("Discount"))+" : ",1),o("span",null,d(n.nsCurrency(i.order.discount)),1)]),o("div",ct,[o("span",null,d(n.__("Paid"))+" : ",1),o("span",null,d(n.nsCurrency(i.order.tendered)),1)]),o("div",dt,[o("span",null,d(n.__("Change"))+" : ",1),o("span",null,d(n.nsCurrency(i.order.change)),1)]),o("div",pt,[o("span",null,d(n.__("Current Balance"))+" : ",1),o("span",null,d(n.nsCurrency(i.order.customer.account_amount)),1)]),o("div",mt,[o("span",null,d(n.__("Screen"))+" : ",1),o("span",null,d(n.nsCurrency(i.screenValue)),1)])])])):f("",!0),o("div",ht,[o("div",_t,[o("div",ft,[C(a,{floating:!0,onChanged:e[2]||(e[2]=l=>n.handleChange(l)),onNext:e[3]||(e[3]=l=>n.proceedAddingPayment(l))},{"numpad-footer":O(()=>[o("div",{onClick:e[1]||(e[1]=l=>n.makeFullPayment()),class:"hover:bg-success-tertiary col-span-3 bg-success-secondary text-2xl text-white border border-success-secondary h-16 flex items-center justify-center cursor-pointer"},d(n.__("Full Payment")),1)]),_:1})]),o("div",yt,[o("div",xt,[o("div",{onClick:e[4]||(e[4]=l=>r.increaseBy({value:100})),class:"elevation-surface border hoverable text-2xl text-primary h-16 flex items-center justify-center cursor-pointer"},[o("span",null,d(n.nsCurrency(100)),1)]),o("div",{onClick:e[5]||(e[5]=l=>r.increaseBy({value:500})),class:"elevation-surface border hoverable text-2xl text-primary h-16 flex items-center justify-center cursor-pointer"},[o("span",null,d(n.nsCurrency(500)),1)]),o("div",{onClick:e[6]||(e[6]=l=>r.increaseBy({value:1e3})),class:"elevation-surface border hoverable text-2xl text-primary h-16 flex items-center justify-center cursor-pointer"},[o("span",null,d(n.nsCurrency(1e3)),1)])])])])])])}const gt=A(rt,[["render",bt]]),wt={name:"ns-pos-payment",props:["popup"],data(){return{paymentTypesSubscription:null,paymentsType:[],activePayment:null,order:null,showPayment:!1,orderSubscription:null,currentPaymentComponent:null,activePaymentSubscription:null}},computed:{expectedPayment(){const r=this.order.customer.group.minimal_credit_payment;return this.order.total*r/100}},mounted(){this.orderSubscription=POS.order.subscribe(r=>{this.order=le(r)}),this.activePaymentSubscription=POS.selectedPaymentType.subscribe(r=>{this.activePayment=r,r!==null&&this.loadPaymentComponent(r)}),this.paymentTypesSubscription=POS.paymentsType.subscribe(r=>{this.paymentsType=r,r.filter(e=>{e.selected&&POS.selectedPaymentType.next(e)})}),nsHooks.doAction("ns-pos-payment-mounted",this)},unmounted(){this.activePaymentSubscription.unsubscribe(),this.paymentTypesSubscription.unsubscribe(),this.orderSubscription.unsubscribe(),nsHooks.doAction("ns-pos-payment-destroyed",this)},methods:{__:c,nsCurrency:V,resolveIfQueued:G,loadPaymentComponent(r){switch(r.identifier){case"cash-payment":this.currentPaymentComponent=shallowRef(Xe);break;case"creditcard-payment":this.currentPaymentComponent=shallowRef(tt);break;case"bank-payment":this.currentPaymentComponent=shallowRef(nt);break;case"account-payment":this.currentPaymentComponent=shallowRef(gt);break;default:this.currentPaymentComponent=shallowRef(L);break}},async selectPayment(){try{const r=await new Promise((e,t)=>{w.show(de,{label:c("Select Payment Gateway"),options:this.paymentsType.map(s=>({label:s.label,value:s.identifier})),value:this.activePayment.identifier,resolve:e,reject:t})});this.select(this.paymentsType.filter(e=>e.identifier===r[0].value)[0])}catch{}},select(r){this.showPayment=!1,POS.setPaymentActive(r)},closePopup(){console.log(this.popup),this.popup.close(),POS.selectedPaymentType.next(null)},deletePayment(r){POS.removePayment(r)},selectPaymentAsActive(r){this.select(this.paymentsType.filter(e=>e.identifier===r.target.value)[0])},async submiAsUnpaid(){let r;try{r=await new Promise(t=>{const s=w.show($,{title:c("Save As Unpaid"),message:c("Are you sure you want to save this order as unpaid?"),onAction:i=>{t(i)}})})}catch(t){_.error(t.message||c("An unexpected error occured while saving the order as unpaid.")).subscribe(),console.log(t)}if(!r)return!1;const e=w.show(B);try{POS.order.next({...POS.order.getValue(),payments:[]}),POS.refreshCart();const t=await new Promise((s,i)=>{POS.proceedSubmitting(POS.order.getValue(),s,i)});e.close(),this.popup.close(),_.success(t.message).subscribe(),POS.printOrderReceipt(t.data.order,"silent")}catch(t){e.close(),_.error(t.message||c("An error occured while saving the order as unpaid.")).subscribe()}},getPaymentLabel(r){const e=this.paymentsType.filter(t=>t.identifier===r.identifier)[0];return e?e.label:r.identifier},submitOrder(r={}){const e=w.show(B);try{const t={...POS.order.getValue(),...r};POS.submitOrder(t).then(s=>{e.close(),_.success(s.message).subscribe(),POS.printOrderReceipt(s.data.order,"silent"),this.popup.close()},s=>{e.close(),_.error(s.message).subscribe()})}catch(t){e.close(),_.error(t.message||c("An unexpected error occured while submitting the order.")).subscribe(),console.log(t)}}}},vt={key:0,id:"ns-payment-popup",class:"w-screen h-screen p-8 flex overflow-hidden"},Pt={class:"flex flex-col flex-auto lg:flex-row shadow-xl"},kt={class:"w-full lg:w-56 lg:h-full flex justify-between px-2 lg:px-0 lg:block items-center lg:items-start"},Ct={class:"lg:hidden text-xl text-center my-4 font-bold lg:my-8"},Vt={key:0},Tt={class:"hidden lg:block"},St=["onClick"],Ot={class:"px-2 rounded-full h-8 w-8 flex items-center justify-center ns-label"},At={class:"overflow-hidden flex flex-col flex-auto"},Ft={class:"flex flex-col flex-auto overflow-hidden"},jt={class:"h-12 hidden items-center justify-between lg:flex"},qt={class:"text-xl hidden lg:block text-center my-4 font-bold lg:my-8"},It={key:0,class:"hidden-md"},Qt={class:"px-2"},Ut={key:0,class:"flex flex-auto ns-payment-wrapper overflow-y-auto"},$t={key:1,class:"flex flex-auto items-center justify-center bg-white"},Rt={class:"font-bold text-center text-3xl"},Et={class:"text-center"},Bt={key:2,class:"flex flex-auto ns-payment-wrapper overflow-y-auto p-2 flex-col"},Dt={class:"text-center font-bold py-2"},Lt={class:"flex-auto"},Wt={key:0,class:"p-2 flex justify-center mb-2 items-center"},Nt={class:"font-semibold"},Yt={class:"flex items-center"},Ht=["onClick"],Mt={key:1,class:"default rounded-full h-8 w-8 flex items-center justify-center ml-2"},zt={key:0,class:"flex lg:hidden ns-payment-buttons"},Gt={class:"text-sm"},Kt={class:"text-sm"},Jt={class:"text-sm"},Xt={class:"text-sm mr-1"},Zt={class:"px-2 rounded-full h-6 w-6 text-xs flex items-center justify-center ns-label"},es={key:1,class:"flex-col sm:flex-row w-full ns-payment-footer justify-end p-2 hidden lg:flex"},ts={class:"flex justify-end"},ss={key:1,class:"flex -mx-2"},is={class:"px-2"},rs={key:0,class:"px-2"};function os(r,e,t,s,i,n){const a=T("ns-close-button"),l=T("ns-button");return i.order?(p(),m("div",vt,[o("div",Pt,[o("div",kt,[o("h3",Ct,[S(d(n.__("Gateway"))+" ",1),i.activePayment?(p(),m("span",Vt,": "+d(i.activePayment.label),1)):f("",!0)]),e[12]||(e[12]=o("div",{class:"h-16 hidden lg:block"},null,-1)),o("ul",Tt,[(p(!0),m(j,null,q(i.paymentsType,u=>(p(),m("li",{onClick:h=>n.select(u),class:E([u.selected&&!i.showPayment?"ns-visible":"","cursor-pointer ns-payment-gateway py-2 px-3"]),key:u.identifier},d(u.label),11,St))),128)),i.paymentsType.length>0?(p(),m("li",{key:0,onClick:e[0]||(e[0]=u=>i.showPayment=!0),class:E([i.showPayment?"ns-visible":"","cursor-pointer py-2 px-3 ns-payment-list border-t mt-4 flex items-center justify-between"])},[o("span",null,d(n.__("Payment List")),1),o("span",Ot,d(i.order.payments.length),1)],2)):f("",!0)]),C(a,{class:"lg:hidden",onClick:e[1]||(e[1]=u=>n.closePopup())})]),o("div",At,[o("div",Ft,[o("div",jt,[o("div",null,[o("h3",qt,[S(d(n.__("Gateway"))+" ",1),i.activePayment?(p(),m("span",It,": "+d(i.activePayment.label),1)):f("",!0)])]),o("div",Qt,[C(a,{onClick:e[2]||(e[2]=u=>n.closePopup())})])]),!i.showPayment&&i.activePayment?(p(),m("div",Ut,[(p(),F(ue(i.currentPaymentComponent),{onSubmit:e[3]||(e[3]=u=>n.submitOrder()),label:i.activePayment.label,identifier:i.activePayment.identifier},null,40,["label","identifier"]))])):f("",!0),i.activePayment?f("",!0):(p(),m("div",$t,[o("div",null,[o("h3",Rt,d(n.__("Unable to Proceed")),1),o("p",Et,d(n.__("Your system doesn't have any valid Payment Type. Consider creating one and try again.")),1)])])),i.showPayment?(p(),m("div",Bt,[o("h3",Dt,d(n.__("List Of Payments")),1),o("ul",Lt,[i.order.payments.length===0?(p(),m("li",Wt,[o("h3",Nt,d(n.__("No Payment added.")),1)])):f("",!0),(p(!0),m(j,null,q(i.order.payments,(u,h)=>(p(),m("li",{key:h,class:"p-2 flex justify-between mb-2 items-center"},[o("span",null,d(n.getPaymentLabel(u)),1),o("div",Yt,[o("span",null,d(n.nsCurrency(u.value)),1),u.id?f("",!0):(p(),m("button",{key:0,onClick:y=>n.deletePayment(u),class:"error rounded-full h-8 w-8 flex items-center justify-center ml-2"},e[13]||(e[13]=[o("i",{class:"las la-trash-alt"},null,-1)]),8,Ht)),u.id?(p(),m("button",Mt,e[14]||(e[14]=[o("i",{class:"las la-lock"},null,-1)]))):f("",!0)])]))),128))])])):f("",!0)]),i.activePayment?(p(),m("div",zt,[o("button",{onClick:e[4]||(e[4]=u=>n.selectPayment()),class:"flex items-center justify-center w-1/3 text-2xl flex-auto h-12 font-bold ns-payment-type-button"},[o("span",Gt,d(n.__("Payment Type")),1)]),i.order.tendered>=i.order.total?(p(),m("button",{key:0,onClick:e[5]||(e[5]=u=>n.submitOrder()),class:"flex items-center justify-center w-1/3 text-2xl flex-auto h-12 ns-submit-button font-bold"},[o("span",Kt,d(n.__("Submit Payment")),1)])):f("",!0),i.order.tendered<i.order.total?(p(),m("button",{key:1,onClick:e[6]||(e[6]=u=>n.submitOrder({payment_status:"unpaid"})),class:"flex items-center justify-center w-1/3 text-2xl flex-auto h-12 ns-layaway-button font-bold"},[o("span",Jt,d(n.__("Layaway")),1)])):f("",!0),o("button",{onClick:e[7]||(e[7]=u=>i.showPayment=!0),class:"w-1/3 flex ns-payment-button text-2xl flex-auto h-12 items-center justify-center font-bold"},[o("span",Xt,d(n.__("Payment List")),1),o("span",Zt,d(i.order.payments.length),1)])])):f("",!0),i.activePayment?(p(),m("div",es,[o("div",ts,[i.order.tendered>=i.order.total?(p(),F(l,{key:0,onClick:e[8]||(e[8]=u=>n.submitOrder()),type:i.order.tendered>=i.order.total?"success":"info"},{default:O(()=>[o("span",null,[e[15]||(e[15]=o("i",{class:"las la-cash-register"},null,-1)),S(" "+d(n.__("Submit Payment")),1)])]),_:1},8,["type"])):f("",!0),i.order.tendered<i.order.total?(p(),m("div",ss,[o("div",is,[i.order.tendered===0?(p(),F(l,{key:0,onClick:e[9]||(e[9]=u=>n.submitOrder({payment_status:"unpaid"})),type:i.order.tendered>=i.order.total?"success":"info"},{default:O(()=>[o("span",null,[e[16]||(e[16]=o("i",{class:"las la-bookmark"},null,-1)),S(" "+d(n.__("Layaway"))+" â€” "+d(n.nsCurrency(n.expectedPayment)),1)])]),_:1},8,["type"])):f("",!0),i.order.tendered>0?(p(),F(l,{key:1,onClick:e[10]||(e[10]=u=>n.submitOrder({payment_status:"unpaid"})),type:"info"},{default:O(()=>[o("span",null,[e[17]||(e[17]=o("i",{class:"las la-save"},null,-1)),S(" "+d(n.__("Update")),1)])]),_:1})):f("",!0)]),i.order.tendered===0?(p(),m("div",rs,[C(l,{onClick:e[11]||(e[11]=u=>n.submiAsUnpaid()),type:"info"},{default:O(()=>[o("span",null,[e[18]||(e[18]=o("i",{class:"las la-hands-helping"},null,-1)),S(" "+d(n.__("Save As Unpaid")),1)])]),_:1})])):f("",!0)])):f("",!0)])])):f("",!0)])])])):f("",!0)}const as=A(wt,[["render",os]]);class W{constructor(e){this.order=e}run(){return new Promise((e,t)=>{w.show(as,{resolve:e,reject:t,order:this.order})})}}window.PaymentQueue=W;class N{constructor(e){this.order=e}run(){return new Promise((e,t)=>this.order.products.length===0?(_.error(c("You need to provide some products before proceeding.")).subscribe(),t(!1)):e(!0))}}window.ProductsQueue=N;class Y{constructor(e){this.order=e}run(){return new Promise((e,t)=>{if(this.order.type===void 0)return w.show(se,{resolve:e,reject:t});e(!0)})}}window.TypeQueue=Y;class ls{constructor(){x(this,"screenIs");this.detect()}detect(){window.innerWidth<544?this.screenIs="xs":window.innerWidth>=544&&window.innerWidth<768?this.screenIs="sm":window.innerWidth>=768&&window.innerWidth<992?this.screenIs="md":window.innerWidth>=992&&window.innerWidth<1200?this.screenIs="lg":window.innerWidth>=1200&&(this.screenIs="xl")}is(e){return e===void 0?this.screenIs:this.screenIs===e}}const us={name:"ns-pos-layaway-popup",props:["popup"],data(){return{fields:[],instalments:[],formValidation:new re,subscription:null,totalPayments:0}},mounted(){this.loadFields()},updated(){setTimeout(()=>{document.querySelector(".is-popup #total_instalments").addEventListener("change",()=>{const r=this.formValidation.extractFields(this.fields).total_instalments;this.generatePaymentFields(r)}),document.querySelector(".is-popup #total_instalments").addEventListener("focus",()=>{document.querySelector(".is-popup #total_instalments").select()})},200)},computed:{expectedPayment(){const r=this.order.customer.group.minimal_credit_payment;return nsRawCurrency(this.order.total*r/100)},order(){return this.popup.params.order.instalments=this.popup.params.order.instalments.map(r=>{for(let e in r)if(typeof r[e]!="object"){if(e==="date"){const t={type:"date",name:e,label:c("Date"),disabled:r.paid===1,value:moment(r.date).format("YYYY-MM-DD")};r[e]=t}else if(e==="amount"){const t={type:"number",name:e,label:c("Amount"),disabled:r.paid===1,value:r.amount};r[e]=t}else if(!["paid","id"].includes(e)){const t={type:"hidden",name:e,value:r[e]};r[e]=t}}return r}),this.popup.params.order}},unmounted(){},methods:{__:c,nsCurrency:V,refreshTotalPayments(){if(this.order.instalments.length>0){const r=nsRawCurrency(this.order.instalments.map(e=>parseFloat(e.amount.value)||0).reduce((e,t)=>parseFloat(e)+parseFloat(t)));this.totalPayments=this.order.total-r}else this.totalPayments=0},removeInstalment(r){const e=this.order.instalments.indexOf(r);this.order.instalments.splice(e,1),this.$forceUpdate()},generatePaymentFields(r){this.order.instalments=new Array(parseInt(r)).fill("").map((e,t)=>({date:{type:"date",name:"date",label:"Date",value:t===0?ns.date.moment.format("YYYY-MM-DD"):""},amount:{type:"number",name:"amount",label:"Amount",value:t===0?this.expectedPayment:0},readonly:{type:"hidden",name:"readonly",value:this.expectedPayment>0&&t===0}})),this.$forceUpdate(),this.refreshTotalPayments()},close(){this.popup.params.reject({status:"error",message:c("You must define layaway settings before proceeding.")}),this.popup.close()},skipInstalments(){this.expectedPayment>0?(this.order.instalments=[{amount:this.expectedPayment,date:ns.date.current}],this.order.final_payment_date=this.order.instalments.reverse()[0].date,this.order.total_instalments=this.order.instalments.length,this.order.support_instalments=!1):(this.order.final_payment_date=ns.date.current,this.order.total_instalments=0,this.order.support_instalments=!1),this.popup.close(),POS.order.next(this.order);const{resolve:r,reject:e}=this.popup.params;return r({order:this.order,skip_layaway:!0})},updateOrder(){if(this.order.instalments.length===0)return _.error(c("Please provide instalments before proceeding.")).subscribe();if(this.fields.forEach(u=>this.formValidation.validateField(u)),!this.formValidation.fieldsValid(this.fields))return _.error(c("Unable to process, the form is not valid")).subscribe();this.$forceUpdate();const r=this.order.instalments.map(u=>({amount:parseFloat(u.amount.value),date:u.date.value})),e=nsRawCurrency(r.map(u=>u.amount).reduce((u,h)=>parseFloat(u)+parseFloat(h)));if(r.filter(u=>u.date===void 0||u.date==="").length>0)return _.error(c("One or more instalments has an invalid date.")).subscribe();if(r.filter(u=>!(u.amount>0)).length>0)return _.error(c("One or more instalments has an invalid amount.")).subscribe();if(r.filter(u=>moment(u.date).isBefore(ns.date.moment.startOf("day"))).length>0)return _.error(c("One or more instalments has a date prior to the current date.")).subscribe();const t=r.filter(u=>moment(u.date).isSame(ns.date.moment.startOf("day"),"day"));let s=0;if(t.forEach(u=>{s+=parseFloat(u.amount)}),s<this.expectedPayment)return _.error(c("The payment to be made today is less than what is expected.")).subscribe();if(e<nsRawCurrency(this.order.total))return _.error(c("Total instalments must be equal to the order total.")).subscribe();r.sort((u,h)=>{const y=moment(u.date),v=moment(h.date);return y.isBefore(v)?-1:y.isAfter(v)?1:0});const i=this.formValidation.extractFields(this.fields);i.final_payment_date=r.reverse()[0].date,i.total_instalments=r.length;const n={...this.popup.params.order,...i,instalments:r},{resolve:a,reject:l}=this.popup.params;return this.popup.close(),POS.order.next(n),a({order:n,skip_layaway:!1})},loadFields(){k.get("/api/fields/ns.layaway").subscribe(r=>{this.fields=this.formValidation.createFields(r),this.fields.forEach(e=>{e.name==="total_instalments"&&(e.value=this.order.total_instalments||0)})})}}},cs={class:"shadow-lg h-95vh md:h-5/6-screen lg:h-5/6-screen w-95vw md:w-4/6-screen lg:w-3/6-screen ns-box flex flex-col"},ds={class:"p-2 border-b ns-box-header flex justify-between items-center"},ps={class:"font-semibold"},ms={class:"p-2 flex-auto flex flex-col relative overflow-y-auto"},hs={key:0,class:"absolute h-full w-full flex items-center justify-center"},_s={class:"p-2 elevation-surface info mb-2 text-center text-2xl font-bold flex justify-between"},fs={class:"flex flex-col flex-auto overflow-hidden"},ys={class:"border-b ns-box-body"},xs={class:"text-2xl flex justify-between py-2 text-primary"},bs={class:"text-sm"},gs={class:"p-2 mb-2 text-center bg-green-200 text-green-700"},ws={class:"flex-auto overflow-y-auto"},vs={class:"flex flex-auto"},Ps={class:"px-1 w-full md:w-1/2"},ks={class:"px-1 w-full md:w-1/2"},Cs={class:"flex items-center"},Vs=["onClick"],Ts={key:0,class:"my-2"},Ss={class:"p-2 elevation-surface border text-primary text-center"},Os={class:"p-2 flex border-t ns-box-footer justify-between flex-shrink-0"},As={class:"md:-mx-1 flex flex-col md:flex-row"},Fs={class:"md:px-1"},js={class:"md:-mx-1 flex flex-col md:flex-row"},qs={class:"md:px-1"},Is={class:"md:px-1"};function Qs(r,e,t,s,i,n){const a=T("ns-close-button"),l=T("ns-spinner"),u=T("ns-field"),h=T("ns-button");return p(),m("div",cs,[o("div",ds,[o("h3",ps,d(n.__("Layaway Parameters")),1),o("div",null,[C(a,{onClick:e[0]||(e[0]=y=>n.close())})])]),o("div",ms,[i.fields.length===0?(p(),m("div",hs,[C(l)])):f("",!0),o("div",_s,[o("span",null,d(n.__("Minimum Payment")),1),o("span",null,d(n.nsCurrency(n.expectedPayment)),1)]),o("div",null,[(p(!0),m(j,null,q(i.fields,(y,v)=>(p(),F(u,{field:y,key:v},null,8,["field"]))),128))]),o("div",fs,[o("div",ys,[o("h3",xs,[o("span",null,d(n.__("Instalments & Payments")),1),o("p",null,[o("span",bs,"("+d(n.nsCurrency(i.totalPayments))+")",1),o("span",null,d(n.nsCurrency(r.total)),1)])]),o("p",gs,d(n.__("The final payment date must be the last within the instalments.")),1)]),o("div",ws,[(p(!0),m(j,null,q(n.order.instalments,(y,v)=>(p(),m("div",{class:"flex w-full -mx-1 py-2",key:v},[o("div",vs,[o("div",Ps,[C(u,{onChange:e[1]||(e[1]=R=>n.refreshTotalPayments()),field:y.date},null,8,["field"])]),o("div",ks,[C(u,{onChange:e[2]||(e[2]=R=>n.refreshTotalPayments()),field:y.amount},null,8,["field"])])]),o("div",Cs,[o("button",{onClick:R=>n.removeInstalment(y),class:"items-center flex justify-center h-8 w-8 rounded border text-primary ns-inset-button error"},e[6]||(e[6]=[o("i",{class:"las la-times"},null,-1)]),8,Vs)])]))),128)),n.order.instalments.length===0?(p(),m("div",Ts,[o("p",Ss,d(n.__("There is no instalment defined. Please set how many instalments are allowed for this order")),1)])):f("",!0)])])]),o("div",Os,[o("div",As,[o("div",Fs,[C(h,{onClick:e[3]||(e[3]=y=>n.skipInstalments()),type:"info"},{default:O(()=>[S(d(n.__("Skip Instalments")),1)]),_:1})])]),o("div",js,[o("div",qs,[C(h,{onClick:e[4]||(e[4]=y=>n.close()),type:"error"},{default:O(()=>[S(d(n.__("Cancel")),1)]),_:1})]),o("div",Is,[C(h,{onClick:e[5]||(e[5]=y=>n.updateOrder()),type:"info"},{default:O(()=>[S(d(n.__("Proceed")),1)]),_:1})])])])])}const K=A(us,[["render",Qs]]),Us=window.nsPosDashboardButton=U(()=>Q(()=>import("./ns-pos-dashboard-button-D2hKHzyk.js"),__vite__mapDeps([0,1,2,3]),import.meta.url)),$s=window.nsPosPendingOrderButton=U(()=>Q(()=>import("./ns-pos-pending-orders-button-B9WVGtMo.js"),__vite__mapDeps([4,5,1,6,3,7,2,8]),import.meta.url)),Rs=window.nsPosOrderTypeButton=U(()=>Q(()=>import("./ns-pos-order-type-button-CUGXSXz7.js"),__vite__mapDeps([9,5,1,6,3,10,7,2,8,11]),import.meta.url)),Es=window.nsPosCustomersButton=U(()=>Q(()=>import("./ns-pos-customers-button-CAhxMm26.js"),__vite__mapDeps([12,5,1,6,3,10,7,2,8,11]),import.meta.url)),Bs=window.nsPosResetButton=U(()=>Q(()=>import("./ns-pos-reset-button-C7IIA6Fy.js"),__vite__mapDeps([13,5,1,6,3,7,2,8]),import.meta.url)),Ds=window.nsPosCashRegister=U(()=>Q(()=>import("./ns-pos-registers-button-yVpibaoH.js"),__vite__mapDeps([14,5,1,6,3,7,2,8]),import.meta.url));window.nsLayawayPopup=K;window.nsPosShippingPopup=z;window.CustomerQueue=D;window.PaymentQueue=W;window.ProductsQueue=N;window.TypeQueue=Y;let J=class{constructor(){x(this,"_cartButtons");x(this,"_products");x(this,"_breadcrumbs");x(this,"_customers");x(this,"_settings");x(this,"_types");x(this,"_orderTypeProcessQueue",[]);x(this,"_paymentsType");x(this,"_order");x(this,"_screen");x(this,"_holdPopupEnabled",!0);x(this,"_initialQueue",[]);x(this,"_options");x(this,"_responsive",new ls);x(this,"_visibleSection");x(this,"_isSubmitting",!1);x(this,"_processingAddQueue",!1);x(this,"_selectedPaymentType");x(this,"_userPermissions");x(this,"print");x(this,"defaultOrder",()=>({discount_type:null,title:"",discount:0,register_id:this.get("register")?this.get("register").id:void 0,discount_percentage:0,subtotal:0,total:0,coupons:[],total_coupons:0,tendered:0,note:"",note_visibility:"hidden",tax_group_id:void 0,tax_type:void 0,taxes:[],tax_group:{},payment_status:void 0,customer_id:void 0,change:0,total_products:0,shipping:0,tax_value:0,products_tax_value:0,shipping_rate:0,shipping_type:void 0,customer:void 0,type:void 0,products:[],instalments:[],payments:[],addresses:{shipping:void 0,billing:void 0}}));x(this,"addToCartQueue",[Fe,ie]);this.initialize(),this.print=new oe({urls:systemUrls,options:systemOptions})}get screen(){return this._screen}get visibleSection(){return this._visibleSection}get paymentsType(){return this._paymentsType}get selectedPaymentType(){return this._selectedPaymentType}get order(){return this._order}get types(){return this._types}get products(){return this._products}get customers(){return this._customers}get options(){return this._options}get orderTypeQueue(){return this._orderTypeProcessQueue}get settings(){return this._settings}get breadcrumbs(){return this._breadcrumbs}get initialQueue(){return this._initialQueue}get responsive(){return this._responsive}get processingAddQueue(){return this._processingAddQueue}get cartButtons(){return this._cartButtons}async reset(){return new Promise(async(e,t)=>{try{this._isSubmitting=!1,this.order.next(this.defaultOrder()),this.products.next([]),this._customers.next([]),this._breadcrumbs.next([]),this._cartButtons.next({}),this.defineCurrentScreen(),this.setHoldPopupEnabled(!0),b.doAction("ns-before-cart-reset"),await this.processInitialQueue(),b.doAction("ns-after-cart-changed"),b.doAction("ns-after-cart-reset"),e(!0)}catch(s){t(s)}})}initialize(){this._userPermissions=new P([]),this._products=new P([]),this._customers=new P([]),this._types=new P([]),this._breadcrumbs=new P([]),this._screen=new P(""),this._paymentsType=new P([]),this._visibleSection=new P("both"),this._options=new P({}),this._settings=new P({}),this._order=new P(this.defaultOrder()),this._selectedPaymentType=new P(null),this._cartButtons=new P({}),this._orderTypeProcessQueue=[{identifier:"handle.delivery-order",promise:e=>new Promise((t,s)=>e&&e.identifier==="delivery"?w.show(z,{resolve:t,reject:s}):t({status:"success",message:"Proceed"}))}],this.initialQueue.push(()=>new Promise((e,t)=>{k.get("/api/users/permissions/").subscribe({next:s=>{this._userPermissions.next(s),e(s)},error:s=>{t(s)}})})),this.initialQueue.push(()=>new Promise((e,t)=>{const s=this.options.getValue(),i=this.order.getValue();return i.tax_type=s.ns_pos_tax_type,s.ns_pos_tax_group!==!1&&(i.tax_group_id=s.ns_pos_tax_group,this.order.next(i)),e({status:"success",message:"tax group assignated"})})),this.initialQueue.push(()=>new Promise((e,t)=>{const s=this.options.getValue();return this.order.getValue(),s.ns_customers_default!==!1&&k.get(`/api/customers/${s.ns_customers_default}`).subscribe({next:i=>{this.selectCustomer(i),e({status:"success",message:c("The customer has been loaded")})},error:i=>{H.error(c("An error has occured"),c("Unable to select the default customer. Looks like the customer no longer exists. Consider changing the default customer on the settings."),{actions:{readMore:{label:c("Read More"),onClick:n=>{n.close(),window.open("https://my.nexopos.com/en/documentation/troubleshooting/no-default-customer","_blank")}},close:{label:c("Close")}}}),t(i)}}),e({status:"success",message:"no default customer is selected."})})),b.addAction("ns-after-cart-changed","listen-add-to-cart",()=>this.refreshCart()),this.types.subscribe(e=>{const t=Object.values(e).filter(s=>s.selected);if(t.length>0){const s=this.order.getValue();s.type=t[0],this.order.next(s)}}),window.addEventListener("resize",()=>{this._responsive.detect(),this.defineCurrentScreen()}),window.onbeforeunload=()=>{if(this.products.getValue().length>0)return c("Some products has been added to the cart. Would you like to discard this order ?")}}getSalePrice(e){let t=0;return this.options.getValue().ns_pos_price_with_tax==="yes"?t=I(e.sale_price_with_tax):t=I(e.sale_price_without_tax),b.applyFilters("ns-pos-product-sale-price",t,e)}getCustomPrice(e){let t=0;return this.options.getValue().ns_pos_price_with_tax==="yes"?t=I(e.custom_price_with_tax):t=I(e.custom_price_without_tax),b.applyFilters("ns-pos-product-custom-price",t,e)}getWholesalePrice(e){let t=0;return this.options.getValue().ns_pos_price_with_tax==="yes"?t=I(e.wholesale_price_with_tax):t=I(e.wholesale_price_without_tax),b.applyFilters("ns-pos-product-wholesale-price",t,e)}setHoldPopupEnabled(e=!0){this._holdPopupEnabled=e}getHoldPopupEnabled(){return this._holdPopupEnabled}async processInitialQueue(){return new Promise(async(e,t)=>{for(let s in this._initialQueue)try{const i=await Promise.race([this._initialQueue[s](),new Promise((n,a)=>setTimeout(()=>a(new Error("Timeout")),6e4))])}catch(i){t(i),_.error(i.message).subscribe()}e(!0)})}removeCoupon(e){const t=this.order.getValue(),s=t.coupons,i=s.indexOf(e);s.splice(i,1),t.coupons=s,this.order.next(t)}pushCoupon(e){const t=this.order.getValue();t.coupons.forEach(s=>{if(s.code===e.code){const i=c("This coupon is already added to the cart");throw _.error(i).subscribe(),i}}),t.coupons.push(e),this.order.next(t),this.refreshCart()}get header(){const e={buttons:{nsPosDashboardButton:Us,nsPosPendingOrderButton:$s,nsPosOrderTypeButton:Rs,nsPosCustomersButton:Es,nsPosResetButton:Bs}};return this.options.getValue().ns_pos_registers_enabled==="yes"&&(e.buttons.nsPosCashRegister=Ds),b.doAction("ns-pos-header",e),e}defineOptions(e){this._options.next(e)}defineCurrentScreen(){this._visibleSection.next(["xs","sm"].includes(this._responsive.is())?"grid":"both"),this._screen.next(this._responsive.is())}changeVisibleSection(e){["both","cart","grid"].includes(e)&&(["cart","both"].includes(e)&&this.refreshCart(),this._visibleSection.next(e))}addPayment(e){if(e.value>0){const t=this._order.getValue();return t.payments.push(e),this._order.next(t),this.computePaid()}return _.error("Invalid amount.").subscribe()}removePayment(e){if(e.id!==void 0)return _.error(c("Unable to delete a payment attached to the order.")).subscribe();const t=this._order.getValue(),s=t.payments.indexOf(e);t.payments.splice(s,1),this._order.next(t),nsEvent.emit({identifier:"ns.pos.remove-payment",value:e}),this.updateCustomerAccount(e),this.computePaid()}updateCustomerAccount(e){if(e.identifier==="account-payment"){const t=this.order.getValue().customer;t.account_amount+=e.value,this.selectCustomer(t)}}getPriceWithoutTax(e,t,s){if(s==="inclusive")return M.computeInclusive(e,t);if(s==="exclusive")return e}getPriceWithTax(e,t,s){if(s==="inclusive")return e;if(s==="exclusive")return M.computeExclusive(e,t)}getVatValue(e,t,s){return s==="inclusive"?e-this.getPriceWithoutTax(e,t,s):s==="exclusive"?this.getPriceWithTax(e,t,s)-e:0}computeTaxes(){return new Promise((e,t)=>{let s=this.order.getValue();if(s.tax_group_id===void 0||s.tax_group_id===null)return this.computeOrderTaxes(s),e({data:{order:s},status:"success"});const i=s.tax_group;if(i.id!==void 0)return i.id===s.tax_group_id&&(s=this.computeOrderTaxGroup(s,i)),e({status:"success",data:{tax:i,order:s}});if(![void 0,null].includes(s.tax_group_id)&&s.tax_group_id.toString().length>0)k.get(`/api/taxes/groups/${s.tax_group_id}`).subscribe({next:n=>(s=this.computeOrderTaxGroup(s,n),e({status:"success",data:{tax:n,order:s}})),error:n=>t(n)});else return t({status:"error",message:c("No tax group assigned to the order")})})}computeOrderTaxGroup(e,t){const s=t.taxes.map(n=>parseFloat(n.rate)).reduce((n,a)=>n+a),i=this.getVatValue(e.subtotal-e.discount,s,e.tax_type);if(t.taxes=t.taxes.map(n=>{const a=g(g(n.rate).divide(s).done()).multiply(100).done();return{id:n.id,tax_id:n.tax_id,name:n.name,rate:parseFloat(n.rate),tax_value:g(g(i).multiply(a).done()).divide(100).done()}}),t.taxes.length===0){_.error(c("The selected tax group doesn't have any assigned sub taxes. This might cause wrong figures."),c("Proceed"),{duration:!1}).subscribe();return}return e.tax_group=e.tax_group||{},e.taxes=t.taxes,e.tax_group=t,this.computeOrderTaxes(e)}computeOrderTaxes(e){const t=this.options.getValue(),s=t.ns_pos_vat;return t.ns_pos_price_with_tax,["flat_vat","variable_vat"].includes(s)&&e.taxes&&e.taxes.length>0&&(e.tax_value+=e.taxes.map(i=>i.tax_value).reduce((i,n)=>i+n)),e}sumProductsTaxes(e){const t=this.products.getValue(),s=this.options.getValue(),i=s.ns_pos_vat;if(e.products=t,e.total_products=t.length,["products_vat"].includes(i)||s.ns_pos_price_with_tax==="no"){const n=t.map(a=>a.total_tax_value);n.length>0&&(e.products_tax_value=n.reduce((a,l)=>a+l))}return s.ns_pos_price_with_tax==="no"&&(e.subtotal=g(e.subtotal).add(e.products_tax_value).done()),e}canProceedAsLaidAway(e){return new Promise(async(t,s)=>{const i=e.customer.group.minimal_credit_payment,n=g(e.total).multiply(i).done();let a=g(n).divide(100).done();a=parseFloat(a);try{const l=await new Promise((u,h)=>{w.show(K,{order:e,reject:h,resolve:u})});if(l.order.instalments.length===0&&l.order.tendered<a){const u=c("Before saving this order, a minimum payment of {amount} is required").replace("{amount}",V(a));return w.show(pe,{title:c("Unable to proceed"),message:u}),s({status:"error",message:u})}else{const u=this.selectedPaymentType.getValue(),h=l.order.instalments.filter(v=>v.amount>=a&&ae(v.date).isSame(ns.date.moment.startOf("day"),"day"));if(h.length===0)return t({status:"success",message:c("Layaway defined"),data:{order:l.order}});const y=h[0].amount;y>0?w.show($,{title:c("Initial Payment"),message:c('In order to proceed, an initial payment of {amount} is required for the selected payment type "{paymentType}". Would you like to proceed ?').replace("{amount}",V(y)).replace("{paymentType}",u.label),onAction:v=>{if(v){const R={identifier:u.identifier,label:u.label,value:y,readonly:!1,selected:!0};this.addPayment(R),h[0].paid=!0,t({status:"success",message:c("Layaway defined"),data:{order:l.order}})}else s({status:"error",message:c("The request was canceled")})}}):t({status:"success",message:c("Layaway defined"),data:{order:l.order}})}}catch(l){return s(l)}})}submitOrder(e={}){return new Promise(async(t,s)=>{var i={...this.order.getValue(),...e};const n=i.customer.group.minimal_credit_payment;if(i.payment_status!=="hold"&&i.payments.length===0&&i.total>0&&i.total>i.tendered){if(this.options.getValue().ns_orders_allow_partial==="no"){const a=c("Partially paid orders are disabled.");return s({status:"error",message:a})}else if(n>=0)try{i=(await this.canProceedAsLaidAway(i)).data.order}catch(a){return s(a)}}return this._isSubmitting?s({status:"error",message:c("An order is currently being processed.")}):(this._isSubmitting=!0,this.proceedSubmitting(i,t,s))})}proceedSubmitting(e,t,s){const i=e.id!==void 0?"put":"post";return b.doAction("ns-order-before-submit",e),k[i](`/api/orders${e.id!==void 0?"/"+e.id:""}`,e).subscribe({next:n=>{t(n),this.reset(),b.doAction("ns-order-submit-successful",n),this._isSubmitting=!1;const a=this.options.getValue().ns_pos_complete_sale_audio;a.length>0&&new Audio(a).play()},error:n=>{this._isSubmitting=!1,s(n),b.doAction("ns-order-submit-failed",n)}})}defineQuantities(e,t=[]){return new Promise((s,i)=>{const a={unit:t.filter(u=>u.id===e.unit_id)[0]||{},sale_price_with_tax:e.mode==="normal"?parseFloat(e.price_with_tax):0,sale_price_without_tax:e.mode==="normal"?parseFloat(e.price_without_tax):0,sale_price:e.mode==="normal"?parseFloat(e.unit_price):0,sale_price_tax:e.mode==="normal"?e.tax_value:0,sale_price_edit:0,wholesale_price_with_tax:e.mode==="wholesale"?parseFloat(e.price_with_tax):0,wholesale_price_without_tax:e.mode==="wholesale"?parseFloat(e.price_without_tax):0,wholesale_price:e.mode==="wholesale"?parseFloat(e.unit_price):0,wholesale_price_tax:e.mode==="wholesale"?e.tax_value:0,wholesale_price_edit:0,custom_price_with_tax:e.mode==="custom"?parseFloat(e.price_with_tax):0,custom_price_without_tax:e.mode==="custom"?parseFloat(e.price_without_tax):0,custom_price:e.mode==="custom"?parseFloat(e.unit_price):0,custom_price_tax:e.mode==="custom"?e.tax_value:0,custom_price_edit:e.mode==="custom"?parseFloat(e.unit_price):0};let l;if(["inclusive","exclusive"].includes(e.tax_type))try{if(e.tax_group_id)k.get(`/api/taxes/groups/${e.tax_group_id}`).subscribe({next:u=>(["sale","wholesale","custom"].forEach(h=>{a[h+"_price_tax"]=u.taxes.map(y=>this.getVatValue(a[h+"_price"],y.rate,e.tax_type)).reduce((y,v)=>y+v),a["gross_"+h+"_price"]=a[h+"_price"]+a[h+"_price_tax"],a["net_"+h+"_price"]=a[h+"_price"]-a[h+"_price_tax"]}),l=u,s(a)),error:u=>{i(!1)}});else return a.sale_price_tax=0,a.wholesale_price_tax=0,a.sale_price_without_tax=e.unit_price,s(a)}catch{return _.error(c("An error has occurred while computing the product.")).subscribe()}return s(a)})}loadOrder(e){return new Promise((t,s)=>{k.get(`/api/orders/${e}/pos`).subscribe({next:async i=>{try{b.doAction("ns-before-load-order",{order:i})}catch(a){return s(a)}this.options.getValue(),i={...this.defaultOrder(),...i};const n=[];for(let a=0;a<i.products.length;a++){const l=i.products[a];l.product===null&&(l.product={mode:"custom",name:l.name,unit_id:l.unit_id,unit_quantities:[await this.defineQuantities(l)]}),l.$original=()=>l.product,l.$quantities=()=>{let u=l.product.unit_quantities.filter(h=>+h.id==+l.unit_quantity_id||h.id===void 0)[0];return l.mode==="custom"&&(u.custom_price_edit=l.unit_price,u.custom_price_with_tax=l.price_with_tax,u.custom_price_without_tax=l.price_without_tax,u.custom_price_tax=l.tax_value),u},n.push(l)}i.type=Object.values(this.types.getValue()).filter(a=>a.identifier===i.type)[0],i.addresses={shipping:i.shipping_address,billing:i.billing_address},delete i.shipping_address,delete i.billing_address,this.buildOrder(i),this.buildProducts(n),await this.selectCustomer(i.customer),t(i)},error:i=>s(i)})})}buildOrder(e){this.order.next(e)}buildProducts(e){this.recomputeProducts(e),this.products.next(e),b.doAction("ns-after-cart-changed")}printOrderReceipt(e,t){const s=this.options.getValue();if(s.ns_pos_printing_enabled_for==="disabled")return!1;if(s.ns_pos_printing_enabled_for==="all_orders"||s.ns_pos_printing_enabled_for==="partially_paid_orders"&&["paid","partially_paid"].includes(e.payment_status)||s.ns_pos_printing_enabled_for==="only_paid_orders"&&["paid"].includes(e.payment_status))this.print.process(e.id,"sale",t);else return!1}computePaid(){const e=this._order.getValue();e.tendered=0,e.payments.length>0&&(e.tendered=e.payments.map(t=>t.value).reduce((t,s)=>s+t)),e.tendered>=e.total?e.payment_status="paid":e.tendered>0&&e.tendered<e.total&&(e.payment_status="partially_paid"),e.change=e.tendered-e.total,this._order.next(e)}setPaymentActive(e){const t=this._paymentsType.getValue();t.forEach(s=>{s.identifier===e.identifier?s.selected=!0:s.selected=!1}),this._paymentsType.next(t)}definedPaymentsType(e){this._paymentsType.next(e)}selectCustomer(e){return new Promise((t,s)=>{const i=this.order.getValue(),n=Object.assign(e.billing||{},{});if(n.id!==void 0&&delete n.id,i.customer=e,i.customer_id=e.id,i.addresses.billing=n,this.order.next(i),e.group===void 0||e.group===null)k.get(`/api/customers/${e.id}/group`).subscribe({next:a=>{i.customer.group=a,this.order.next(i),t(i)},error:a=>{s(a)}});else return t(i)})}updateCart(e,t){for(let s in t)t[s]!==void 0&&(e[s]=t[s]);this.order.next(e),this.refreshCart()}checkCart(){const e=this.order.getValue(),t=[];e.coupons.forEach(s=>{let i=!0;s.products.length>0&&(i=e.products.filter(a=>s.products.map(l=>l.product_id).includes(a.product_id)).length>0,!i&&t.indexOf(s)===-1&&t.push(s));let n=!0;s.categories.length>0&&(n=e.products.filter(a=>s.categories.map(l=>l.category_id).includes(a.$original().category_id)).length>0,!n&&t.indexOf(s)===-1&&t.push(s))}),t.forEach(s=>{_.error(c(`The coupons "%s" has been removed from the cart, as it's required conditions are no more meet.`).replace("%s",s.name),c("Okay"),{duration:6e3}).subscribe(),this.removeCoupon(s)})}sumProductsTotals(e){const t=this.products.getValue(),s=t.filter(i=>i.product_type!=="dynamic").map(i=>i.total_price);if(s.length>0){let i=s.reduce((l,u)=>l+u),n=0,a=t.filter(l=>l.product_type==="dynamic").map(l=>(l.unit_price=i*l.rate/100,l.total_price=l.unit_price*l.quantity,l.total_price));a.length>0&&(n=a.reduce((l,u)=>l+u)),e.subtotal=i+n}else e.subtotal=0;return e=this.sumProductsTaxes(e),e}async refreshCart(){this.checkCart();let e=this.sumProductsTotals(this.order.getValue());const t=e.coupons.map(n=>n.type==="percentage_discount"?(n.value=e.subtotal*n.discount_value/100,n.value):(n.value=n.discount_value,n.value));e.total_coupons=0,t.length>0&&(e.total_coupons=t.reduce((n,a)=>n+a)),e.discount_type==="percentage"&&(e.discount=e.discount_percentage*e.subtotal/100),e.discount>e.subtotal&&e.total_coupons===0&&(e.discount=e.subtotal,_.info(c("The discount has been set to the cart subtotal.")).subscribe()),e.tax_value=0,this.order.next(e);try{e=(await this.computeTaxes()).data.order}catch(n){n!==!1&&n.message!==void 0&&_.error(n.message||c("An unexpected error has occurred while fecthing taxes."),c("OKAY"),{duration:0}).subscribe()}const s=e.tax_type;let i=e.tax_value;if(s==="exclusive"){const n=g(e.subtotal).add(e.shipping||0).add(i).done();e.total=g(n).subtract(e.discount).subtract(e.total_coupons).done()}else{const n=g(e.subtotal).add(e.shipping||0).done();e.total=g(n).subtract(e.discount).subtract(e.total_coupons).done()}this.order.next(e),b.doAction("ns-cart-after-refreshed",e)}getStockUsage(e,t){const s=this._products.getValue().filter(i=>i.product_id===e&&i.unit_quantity_id===t).map(i=>i.quantity);return s.length>0?s.reduce((i,n)=>i+n):0}async addToCart(e){let t=new Object,s={product_id:e.id||0,name:e.name,discount_type:"percentage",discount:0,discount_percentage:0,product_type:e.product_type||"product",rate:e.rate||0,quantity:e.quantity||0,tax_group_id:e.tax_group_id,tax_type:e.tax_type||void 0,tax_value:0,unit_id:e.unit_id||0,unit_price:e.unit_price||0,price_with_tax:e.price_with_tax||0,price_without_tax:e.price_without_tax||0,unit_name:e.unit_name||"",total_price:0,total_price_without_tax:0,total_price_with_tax:0,mode:e.mode||"normal",$original:e.$original||(()=>e),$quantities:e.$quantities||void 0};if(this._processingAddQueue=!0,s.product_id!==0)for(let a in this.addToCartQueue)try{const u=await new this.addToCartQueue[a](s).run(t);t={...t,...u}}catch(l){if(l===!1)return this._processingAddQueue=!1,!1}this._processingAddQueue=!1,s={...s,...t};const i=this._products.getValue();if(this.settings.getValue().ns_pos_items_merge){const a=i.filter(l=>l.product_id===s.product_id&&l.tax_group_id===s.tax_group_id&&l.unit_id===s.unit_id&&l.unit_quantity_id===s.unit_quantity_id);a.length>0?a[0].quantity+=s.quantity:i.unshift(s)}else i.unshift(s);this.recomputeProducts(i),this.products.next(i);const n=this.options.getValue().ns_pos_new_item_audio;n.length>0&&new Audio(n).play(),b.doAction("ns-after-cart-changed")}defineTypes(e){this._types.next(e)}userCan(e){return this._userPermissions.getValue().filter(i=>i.namespace===e).length>0}async removeProductUsingIndex(e){const t=this._products.getValue();if(t[e].id)try{await new Promise((i,n)=>{const a=w.show(B);k.post("/api/users/check-permission/",{permission:"nexopos.pos.delete-order-product"}).subscribe({next:l=>{a.close(),i(l)},error:l=>{a.close(),n(l)}})}),this.resumeRemovingProductUsingIndex(e,t)}catch{H.error(c("Forbidden Action"),c("You are not allowed to remove this product."))}else this.resumeRemovingProductUsingIndex(e,t)}resumeRemovingProductUsingIndex(e,t){t.splice(e,1),this.products.next(t),b.doAction("ns-after-cart-changed")}removeProduct(e){const t=this._products.getValue(),s=t.indexOf(e);t.splice(s,1),this.products.next(t),b.doAction("ns-after-cart-changed")}updateProduct(e,t,s=null){const i=this._products.getValue();s=s===null?i.indexOf(e):s,s=s===-1?0:s,i[s]={...e,...t},this.recomputeProducts(i),this.products.next(i),b.doAction("ns-after-cart-changed")}recomputeProducts(e=null){e.forEach(t=>{this.computeProduct(t)})}getProductUnitPrice(e,t){switch(e){case"custom":return t.custom_price_edit;case"normal":return t.sale_price_edit;case"wholesale":return t.wholesale_price_edit}}computeProductTax(e){switch(e.mode){case"custom":return this.computeCustomProductTax(e);case"normal":return this.computeNormalProductTax(e);case"wholesale":return this.computeWholesaleProductTax(e);default:return e}}proceedProductTaxComputation(e,t){const s=e.$original(),i=s.tax_group;let n=this.getProductUnitPrice(e.mode,e.$quantities()),a=0,l=this.getProductUnitPrice(e.mode,e.$quantities());if(i!=null&&i.taxes!==void 0){let u=0;switch(i.taxes.length>0&&(u=i.taxes.map(h=>h.rate).reduce((h,y)=>h+y)),s.tax_type){case"inclusive":n=this.getPriceWithoutTax(t,u,s.tax_type),l=t,a=this.getVatValue(g(l).multiply(e.quantity).subtract(e.discount).done(),u,s.tax_type);break;case"exclusive":n=t,l=this.getPriceWithTax(t,u,s.tax_type),a=this.getVatValue(g(n).multiply(e.quantity).subtract(e.discount).done(),u,s.tax_type);break}}return{price_without_tax:n,tax_value:a,price_with_tax:l}}computeCustomProductTax(e){const t=e.$quantities(),s=this.proceedProductTaxComputation(e,t.custom_price_edit);return t.custom_price_without_tax=s.price_without_tax,t.custom_price_with_tax=s.price_with_tax,t.custom_price_tax=s.tax_value,e.$quantities=()=>t,e}computeNormalProductTax(e){const t=e.$quantities(),s=this.proceedProductTaxComputation(e,t.sale_price_edit);return t.sale_price_without_tax=s.price_without_tax,t.sale_price_with_tax=s.price_with_tax,t.sale_price_tax=s.tax_value,e.$quantities=()=>t,e}computeWholesaleProductTax(e){const t=e.$quantities(),s=this.proceedProductTaxComputation(e,t.wholesale_price_edit);return t.wholesale_price_without_tax=s.price_without_tax,t.wholesale_price_with_tax=s.price_with_tax,t.wholesale_price_tax=s.tax_value,e.$quantities=()=>t,e}getPrice(e,t,s){switch(t){case"normal":return e["sale_price_"+s];case"wholesale":return e["wholesale_price_"+s];case"custom":return e["custom_price_"+s]}}computeProduct(e){e.product_type==="product"&&(e.mode==="normal"?e.unit_price=this.getSalePrice(e.$quantities()):e.mode==="wholesale"&&(e.unit_price=this.getWholesalePrice(e.$quantities())),e.mode==="custom"&&(e.unit_price=this.getCustomPrice(e.$quantities()))),this.computeDiscount(e),this.computeProductTaxValue(e);let t=b.applyFilters("ns-pos-product-unit-price",e.unit_price,e);e.total_price=g(t).multiply(e.quantity).subtract(e.discount).done(),e.total_tax_value=g(e.tax_value).multiply(e.quantity).done(),b.doAction("ns-after-product-computed",e)}computeProductTaxValue(e){const t=e.$original().tax_group,s=b.applyFilters("ns-pos-product-unit-price",e.unit_price,e);let i=this.computeTaxForGroup(g(s).done(),t,this.options.getValue().ns_pos_price_with_tax==="yes"?"inclusive":"exclusive");e.tax_value=i.tax_value,e.total_tax_value=e.tax_value*e.quantity,e.price_with_tax=i.price_with_tax,e.price_without_tax=i.price_without_tax,e.total_price_with_tax=g(i.price_with_tax).multiply(e.quantity).subtract(e.discount).done(),e.total_price_without_tax=g(i.price_without_tax).multiply(e.quantity).subtract(e.discount).done()}computeTaxForGroup(e,t,s){let i=0,n=0,a=0,l=[];if(t&&(l=t.taxes.map(u=>({...u,tax_value:this.getVatValue(e,u.rate,s)}))),l.length>0){const u=l.map(h=>h.rate).reduce((h,y)=>h+y);i=this.getVatValue(e,u,s),a=this.getPriceWithoutTax(e,u,s),n=this.getPriceWithTax(e,u,s)}return{...t,taxes:l,tax_value:i,price_with_tax:n,price_without_tax:a}}async runPaymentQueue(){const e=b.applyFilters("ns-pay-queue",[N,D,Y,W]);for(let t in e)try{const i=await new e[t](this.order.getValue()).run()}catch(s){return console.log(s),!1}}computeDiscount(e){if(["flat","percentage"].includes(e.discount_type)&&e.discount_type==="percentage"){let t=b.applyFilters("ns-pos-product-unit-price",e.unit_price,e);e.discount=g(g(g(t).multiply(e.discount_percentage).done()).divide(100).done()).multiply(e.quantity).done()}}loadCustomer(e){return k.get(`/api/customers/${e}`)}defineSettings(e){this._settings.next(e)}voidOrder(e){e.id!==void 0?["hold"].includes(e.payment_status)?w.show($,{title:c("Order Deletion"),message:c("The current order will be deleted as no payment has been made so far."),onAction:t=>{t&&k.delete(`/api/orders/${e.id}`).subscribe({next:s=>{_.success(s.message).subscribe(),this.reset()},error:s=>_.error(s.message).subscribe()})}}):w.show(me,{title:c("Void The Order"),message:c("The current order will be void. This will cancel the transaction, but the order won't be deleted. Further details about the operation will be tracked on the report. Consider providing the reason of this operation."),onAction:t=>{t!==!1&&k.post(`/api/orders/${e.id}/void`,{reason:t}).subscribe({next:s=>{_.success(s.message).subscribe(),this.reset()},error:s=>_.error(s.message).subscribe()})}}):_.error(c("Unable to void an unpaid order.")).subscribe()}async triggerOrderTypeSelection(e){for(let t=0;t<this.orderTypeQueue.length;t++)await this.orderTypeQueue[t].promise(e)}set(e,t){const s=this.settings.getValue();s[e]=t,this.settings.next(s)}unset(e){const t=this.settings.getValue();delete t[e],this.settings.next(t)}get(e){return this.settings.getValue()[e]}destroy(){this._products.unsubscribe(),this._customers.unsubscribe(),this._types.unsubscribe(),this._breadcrumbs.unsubscribe(),this._paymentsType.unsubscribe(),this._screen.unsubscribe(),this._order.unsubscribe(),this._settings.unsubscribe()}};window.POS=new J;window.POSClass=J;
